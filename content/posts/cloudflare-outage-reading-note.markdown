---
title: Cloudflare å…¨çƒå®•æœºå¤ç›˜è¯»åæ„Ÿ
date: 2019-07-27 21:45:50
categories:
- SRE
---


Cloudflare åœ¨ä¸ƒæœˆäºŒæ—¥å‘ç”Ÿäº†ä¸€æ¬¡å…¨çƒæ€§çš„å®•æœºï¼Œä¸ªäººæ‰˜ç®¡åœ¨ä¸Šé¢çš„ä¸¤ä¸ªå°ç½‘ç«™éš¾ä»¥å¹¸å…ï¼Œ502 è¶…è¿‡åŠä¸ªå°æ—¶ï¼›ç”šè‡³ä¸Šç­çš„æ—¶å€™ï¼Œè¿˜æ”¶åˆ°äº†ä¸€äº›ä¸šåŠ¡å‘Šè­¦ï¼ˆæŸäº›æ¸ é“é€šè¿‡ cloudflare åšè·¯ç”±ï¼‰ã€‚å¯è§è¿™æ¬¡æ•…éšœçš„å½±å“èŒƒå›´ä¹‹å¤§ï¼Œäº’è”ç½‘çš„ä¸€äº›åŸºç¡€æœåŠ¡å·²ç»æˆä¸ºäº† 21 ä¸–çºªçš„æ°´ç”µç…¤..

è€Œä½œä¸ºä¸€å SREï¼Œæ˜ç™½åœ¨æ•…éšœçš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸä¸­ï¼Œæœ€å…³é”®çš„ä¸€ç¯å°±æ˜¯æ•…éšœå¤ç›˜(postmortem)ï¼Œä»¥é˜²æ­¢åŒæ ·æ„šè ¢çš„é”™è¯¯ä¸å†å‘ç”Ÿ(é€šå¸¸å¤§æ•…éšœéƒ½æ˜¯ç”±å¾ˆå¤šå°é”™è¯¯è¿é”é€ æˆçš„)ã€‚å‰å¤©åœ¨åƒå²›æ¹– outing åŠå¤œå››ç‚¹ç¡ä¸ç€çš„æ—¶å€™ï¼Œèµ·åºŠå¶é‡è¿™ç¯‡æ–‡ç« [ã€ŠDetails of the Cloudflare outage on July 2, 2019ã€‹](https://blog.cloudflare.com/details-of-the-cloudflare-outage-on-july-2-2019/), ä¸€å£æ°”è¯»å®Œäº†ï¼Œå†™çš„å¾ˆç²¾å½©ï¼ˆå¾ˆä¼šè®²æ•…äº‹ï¼‰ï¼Œå½“ç„¶æ€»è§‰å¾—è¿˜ç¼ºäº†ä»€ä¹ˆã€‚

ç”¨è¿™ç¯‡æ–‡ç« è®°å½•ä¸€ä¸‹ä¸ªäººçš„æ„Ÿå—å’Œæ€è€ƒï¼Œ**å½“ç„¶æ›´åŠ æ¨èé˜…è¯»åŸæ–‡ã€‚**

<!--more-->

# ä»€ä¹ˆæ˜¯ Cloudflare ?
ä»Šå¤©åˆ· Twitter çš„æ—¶å€™åˆšå¥½çœ‹åˆ°ä¸€ä¸ª[å®˜æ–¹çš„å›ç­”](https://support.cloudflare.com/hc/en-us/articles/205177068-Step-1-How-does-Cloudflare-work-)è¿˜æŒºä¸é”™çš„ã€‚æ€»ç»“ä¸€ä¸‹åŸç†å°±æ˜¯åœ¨ç”¨æˆ·ä¸ä½ çš„ç½‘ç«™ä¹‹é—´åŠ äº†ä¸€å±‚ä»£ç†ï¼Œä»¥æå‡ security, performance and reliability.
![](../images/blog/190727_cloudflare_outage/15642299070568.jpg)


# æ•…éšœè¿‡ç¨‹
æŒ‰åŸæ–‡æè¿°æ•´ç†åï¼Œä¹ æƒ¯å°†æ•…éšœçš„æ¯ä¸€æ­¥éƒ½æŒ‰ timeline åˆ—å‡ºæ¥(UTC)ï¼š
![](../images/blog/190727_cloudflare_outage/15642294239100.jpg)

# æ•…éšœåŸå› 
**ä»£ç å˜æ›´ï¼š**ï¼šæ›´æ–° WAF è§„åˆ™æ—¶ï¼Œå¼•å…¥ä¸€ä¸ªå¾ˆå®¹æ˜“å›æº¯ (backtrace) çš„æ­£åˆ™è¡¨è¾¾å¼ï¼Œå°è¯•ç”¨ç”»å›¾å»è§£é‡Š backtrace çš„åŸç†(æ€»æ­¥æ•°ä¸åŸæ–‡ä¸ä¸€è‡´ï¼Œæ˜¯å› ä¸ºæˆ‘çœç•¥äº†ä¸€äº›æ­¥éª¤æ–¹ä¾¿ç†è§£)ï¼š
![](../images/blog/190727_cloudflare_outage/15654414449732.jpg)
~~(Why is zero plural?ğŸ¤”ğŸ˜„)~~

å½“ç„¶å¦‚æœä½ ä¸æƒ³ç»†çœ‹ï¼Œä¹Ÿå¯ä»¥ç›´æ¥çœ‹åŸæ–‡ä¸­çš„åŠ¨ç”»ï¼Œæœ‰ä¸ªå¤§è‡´çš„ä½“æ„Ÿï¼š
![23-steps-1 -1-](../images/blog/190727_cloudflare_outage/23-steps-1%20-1-.gif)

æ€»è€Œè¨€ä¹‹ï¼Œå°±æ˜¯éšç€å­—ç¬¦ä¸²çš„å¢åŠ ï¼Œæ­£åˆ™åŒ¹é…çš„æ—¶é—´å¤æ‚åº¦çˆ†ç‚¸å¢é•¿ï¼Œæœ€ç»ˆå¯¼è‡´ CPU èµ„æºè€—å°½ï¼š
![](../images/blog/190727_cloudflare_outage/15654415085718.jpg)


# æ•…éšœæ ¹å› 
åŸæ–‡ä¸­åˆ—äº†å¾ˆå¤šï¼Œæˆ‘æŒ‘å‡ºäº†ä¸ªäººè®¤ä¸ºå¯¼è‡´æ•…éšœæœ€é‡è¦çš„ä¸‰ç‚¹ï¼š

1. **WAF è§„åˆ™å˜åŠ¨ç›´æ¥è‡ªåŠ¨éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒï¼š** cloudflare çš„ä»£ç å˜æ›´ï¼Œæ­£å¸¸çš„éƒ¨ç½²æ¨¡å¼ä¸ºDOG(å†…éƒ¨å‘˜å·¥) â†’ PIG(éƒ¨åˆ†å…è´¹ç”¨æˆ·) â†’ Canaries(ç°åº¦) â†’ Global(å…¨é‡éƒ¨ç½²), ä½†å¯¹äº WAF è§„åˆ™çš„å˜æ›´ï¼Œç”±äºå¸¸å¸¸éœ€è¦å¿«é€Ÿå…¨çƒéƒ¨ç½²ä»¥ä¾¿äºå¿«é€Ÿåº”æ€¥ï¼Œæ‰€ä»¥æ—¥å¸¸çš„æ¨¡å¼ä¹Ÿéƒ½æ˜¯æ— è„‘ä¸€æŠŠæ¨ã€‚
2. **å…¨çƒæµé‡ä¸‹é™çš„è­¦æŠ¥æ²¡æœ‰ç¬¬ä¸€æ—¶é—´å‘å‡º**
3. **å›æ»šé¢„æ¡ˆæ‰§è¡Œè¶…æ—¶ï¼š** å›æ»šéœ€è¦ç¼–è¯‘ä¸¤éä»£ç  + æƒé™ä¸å†…éƒ¨å¹³å°å¤±æ•ˆçš„é—®é¢˜ï¼Œå¯¼è‡´æ— æ³•ç¬¬ä¸€æ—¶é—´æ­¢è¡€ã€‚

é’ˆå¯¹ä¸Šé¢çš„ä¸¤ç‚¹æ€è€ƒï¼š

1. **æ§åˆ¶å˜æ›´é£é™©ï¼š** ç»å¤§éƒ¨åˆ†çš„æ•…éšœéƒ½æ˜¯ç”±å˜æ›´å¯¼è‡´çš„ï¼Œæ‰€ä»¥åœ¨æˆ‘ä»¬å…¬å¸æœ‰ä¸€ä¸ªä»»ä½•äººéƒ½ä¸èƒ½è§¦ç¢°çš„çº¢çº¿å«åšå˜æ›´ä¸‰æ¿æ–§ï¼šå¯¹äºä»»æ„çº¿ä¸Šå˜æ›´éƒ½éœ€è¦ **å¯ç°åº¦ï¼Œå¯ç›‘æ§ï¼Œå¯å›æ»š**ã€‚å¦‚æœ cloudflare åœ¨è¿™æ¬¡æ•…éšœä¸­çš„å˜æ›´ä¸­ï¼Œéµå®ˆäº†ä¸‰æ¿æ–§çš„ä»»æ„ä¸€ä¸ªï¼Œéƒ½ä¼šå¤§å¤§å‡å°‘æ•…éšœæ¢å¤çš„æ—¶é—´ï¼Œç”šè‡³é¿å…æ•…éšœã€‚å˜æ›´ä¸‰æ¿æ–§çœŸçš„æ˜¯æ— æ•°äººè¡€ä¸æ³ªä¼ æ‰¿ä¸‹æ¥çš„ golden rules.
2. **ä¿é²œï¼š**ä¸ç®¡æ˜¯ Netflix çš„ chaosmonkey è¿˜æ˜¯èš‚èšçš„çº¢è“æ”»é˜²ï¼Œéƒ½æ˜¯ä¸€ç§æ¯”è¾ƒå¥½çš„ä¸šå†…æœ€ä½³å®è·µäº†ï¼Œåªæœ‰çœŸå®é¢‘ç¹çš„å»æ¨¡æ‹Ÿæ•…éšœï¼Œæ‰èƒ½åšåˆ°é¢„æ¡ˆä¸åº”æ€¥èƒ½åŠ›çš„ä¿é²œ & æå‡ã€‚

# å…¶ä»–æ€è€ƒ
> "This generated a Change Request ticket. We use Jira to manage these tickets and a screenshot is below."
> "In the last 60 days, 476 change requests have been handled for the WAF Managed Rules (averaging one every 3 hours)."

Cloudflare çš„å˜æ›´ç®¡ç†&æ„ŸçŸ¥çœ‹ä¸Šå»åšçš„æŒºä¸é”™çš„, ä½†çœŸæ­£å‘ç”Ÿæ•…éšœçš„æ—¶å€™ï¼Œä¹ŸèŠ±äº†å°†è¿‘ **18 åˆ†é’Ÿ**æ‰å®šä½åˆ°æ ¹å› ã€‚å…¬å¸ä¹Ÿæœ‰å¾ˆå¤šäººåœ¨åšã€Œå˜æ›´æ„ŸçŸ¥ã€ä¸ã€Œæ•…éšœå®šä½ã€ï¼Œä½†ä¸ªäººè§‰å¾—æˆ–è®¸ç›¸å¯¹äºæ„ŸçŸ¥ï¼Œæ•…éšœæ ¹å› å®šä½(ä¾‹å¦‚å®šä½å…³è”çš„å˜æ›´)æ‰æ˜¯æœ€éš¾çš„ï¼šæ¯”è¾ƒä¾èµ–äºä¸“å®¶ç»éªŒï¼Œä½†çœŸæ­£å¤§æ•…éšœåˆå¾€å¾€æ˜¯ä¹‹å‰ä»æ¥æ²¡æœ‰é‡åˆ°è¿‡çš„åœºæ™¯ã€‚æ‰€ä»¥æ˜¯ä¸æ˜¯æ¢ä¸ªæ€è·¯ï¼Œå¯¹ä¸æ‰€æœ‰çš„è·Œé›¶å› å­éƒ½åšå¥½é¢„æ¡ˆï¼Œæ•…éšœå‘ç”Ÿæ—¶ï¼Œåªéœ€è¦æ— è„‘æ‰§è¡Œé¢„æ¡ˆå³å¯ï¼Œç¬¬ä¸€æ—¶é—´æ­¢è¡€æ¢å¤ä¸šåŠ¡ï¼Œä¹‹åæ…¢æ…¢æ’æŸ¥åŸå› ã€‚

> "I agree 100% transparency is best. "
> "blame free".

å›½å¤–å’Œå›½å†…æ–‡åŒ–ä¸Šæ¯”è¾ƒå¤§çš„ä¸¤ä¸ªå·®åˆ«ï¼Œä½†ä»è€…è§ä»æ™ºè€…è§æ™ºï¼Œå¤§ç¯å¢ƒçš„é™åˆ¶ï¼Œä¹Ÿå¾ˆéš¾è¯´æœ‰æ‰€è°“çš„å¯¹é”™å§ã€‚


# é“¾æ¥å‚è€ƒ
1. ã€ŠDetails of the Cloudflare outage on July 2, 2019ã€‹: https://blog.cloudflare.com/details-of-the-cloudflare-outage-on-july-2-2019/
2. pageduty: https://www.pagerduty.com/

# å½©è›‹
**æœ€åçš„æœ€åï¼Œè¿™å¥è¯çœŸçš„å¾ˆè§¦åŠ¨æˆ‘ã€‚ã€‚**
> This is the first thing I've ever done professionally that I truly, completely love. I wake up every day just thrilled at the work we're doing. [Source](https://gist.github.com/jgrahamc/6bb02a6f7c3799a1590b3cdb901f8e08)
![](../images/blog/190717_cloudflare_outage/15633465043345.jpg)



--EOF--

