(function(b){var z=$(window),A=function(c,h){(new Request.JSON({url:"/ajax/json/account/info",method:"POST",onSuccess:function(g){g&&200==g.code?h&&h():h?b.authBox(c,h):b.authBox(c)}})).send()};window.addEvent("domready",function(){Object.merge(page,{perma:b.data("perma"),quoteNoteID:"",quoteFollowNoteIDs:"",editor:null,categoryName:b.data("categoryName"),start:function(){var a=$("J_more_op");page.nav();page.search();a&&new b.PopupPanel(a,"J_pop_op_panel",{adjust:{x:0,y:0},onShow:function(){a.addClass("active")},
onHide:function(){a.removeClass("active")}});page.prompt=new Prompt;page.mainPostScoreLog();page.operateLog();page.pageGo();ListMoreOrLess($("J_related_post"));ListMoreOrLess($("J_review_info"));page.initPage()}});page.start();var c=$("J_topic_list").getElements(".topic-entry a img"),h=Cookie.read("quoteTipsCookie");c.forEach(function(a){a.getParent("a").addClass("pic");(new Element("span",{"class":"btn_img_quote Hide J_btnQuote",html:"引&nbsp;&nbsp;用"})).inject(a,"after");"closed"!==h&&(new Element("div",
{"class":"pop-cite-tips Hide J_tipsQuote",html:'<div class="pop-main"><a href="javascript:void(0);" title="关闭" class="close J_btnClose">关闭</a></div>'})).inject(a,"after")});var g;c.addEvents({mouseenter:function(a){a.stop();var e=this,a=e.getOffsetParent(),H=e.getParent(".topic-entry").getSiblings(".user-info")[0].getElement(".J_card").get("user-id"),c=e.get("src"),i={};e.getPosition(a);var a=e.get("width"),d=e.get("height"),f=function(a){if(300<=a.x&&300<=a.y&&(e.getSiblings(".J_btnQuote")[0].removeClass("Hide").removeEvents("click").addEvents({click:function(e){e.stop();
pageTracker._trackPageview("dp_group_detail_picquote_"+b.data("perma")+"_"+$pi.cn||"");(new Request.JSON({url:"/ajax/json/account/info",method:"POST",onSuccess:function(e){if(e&&200==e.code){var d=$("J_note_preview"),i=d.getParent(".my-preview-wrapper");(new Request.JSON({url:"/ajax/json/group/note/quotedPicUpdate",method:"POST",data:{picUrl:c,realWidth:a.x,realHeight:a.y},onSuccess:function(a){i.removeClass("Hide");location.replace("#NoteAdd");if(a&&a.code&&200==a.code){var e=a.msg,a=e.quotePicUrl,
b=e.quotePicWidth,e=e.quotePicHeight;d.set({html:'<div class="topic-entry"><p><img src="'+a+'" width="'+b+'" height="'+e+'"/></p></div>',"data-quotetype":1,"data-quotepichtml":'<img src="'+a+'" width="'+b+'" height="'+e+'"/></p>',"data-quoteuuserid":H})}},onFailure:function(){}})).send()}else b.authBox("引用图片")}})).send()},mouseenter:function(){clearTimeout(g)}}),"closed"!==Cookie.read("quoteTipsCookie"))){var d=e.getSiblings(".J_tipsQuote")[0];d&&d.removeClass("Hide").addEvent("mouseenter",function(){clearTimeout(g)});
d&&d.getElement(".J_btnClose").removeEvents("click").addEvents({click:function(a){a.stop();d.empty().destroy();Cookie.write("quoteTipsCookie","closed",{duration:90})},mouseenter:function(){clearTimeout(g)}})}};if(a&&d)i={x:a,y:d},f(i);else{var j=new Image;j.onload=function(){i={x:j.width,y:j.height};f(i)};j.src=c}},mouseleave:function(){var a=this;g=setTimeout(function(){var e=a.getSiblings(".J_btnQuote"),b=a.getSiblings(".J_tipsQuote");e&&e.addClass("Hide");b&&b.addClass("Hide")},10)}});var f=$("J_topic_list").getElements(".J_dCoinTitle");
if(f.length){var w=[];f.forEach(function(a){w.push(a.getParent(".J_dCoin").get("data-noteid"))});(new Request.JSON({url:"/ajax/json/group/note/dcashloglist",method:"POST",data:{groupId:b.data("groupId"),mainNoteId:b.data("noteId"),noteIds:w.join(",")},onRequest:function(){f.forEach(function(a){a.getNext(".J_dCoinUl").set("html",'<li style="list-style:none; text-align:center;">获取中...</li>')})},onSuccess:function(a){a&&200==a.code&&a.msg.data.forEach(function(a){var b=String(a.noteId),c=a.referType,
d=[];a.logList.forEach(function(a){d.push('<li><a href="'+a.url+'">'+a.title+"</a></li>")});0==c?f[0].getNext(".J_dCoinUl").set("html",d.join("")):(a=w.indexOf(b),f[a].getNext(".J_dCoinUl").set("html",d.join("")))})},onFailure:function(){f.forEach(function(a){a.getNext(".J_dCoinUl").set("html",'<li style="list-style:none; text-align:center;">获取失败T_T</li>')})}})).send();f.addEvent("click",function(a){a.stop();this.toggleClass("fn-more").toggleClass("fn-less").getNext(".J_dCoinUl").toggleClass("Hide")})}var B=
$$(".J_rightBottomOpList");if(!(Browser.ie&&6==Browser.version)){var C=function(){1324<window.getScroll().y?B[0].removeClass("Hide"):B[0].addClass("Hide")};window.addEvent("scroll",function(){C()});window.addEvent("resize",function(){C()})}b.data("canRec")&&(new Request.JSON({url:"/ajax/json/group/note/recNote",method:"POST",data:{groupId:b.data("groupId"),noteId:b.data("noteId")},onSuccess:function(a){if(a&&200==a.code&&(a=a.msg.html))a=new Element("div",{html:a}),$("J_footer")&&a.inject($("J_footer"),
"top")},onFailure:function(){}})).send();c=b.data("privateKey");""!=c&&(new Request.JSON({url:"/ajax/lessFNoteGuide",method:"POST",data:{groupId:b.data("groupId"),privateKey:c},onSuccess:function(a){if(a&&200==a.code&&(a=a.msg.html)){var e=$("J_lessFNoteGuide");e&&e.destroy();var b=(new Element("div",{id:"J_lessFNoteGuide",html:a})).inject($("_followNoteAdd"),"top");b.getElement(".J_btnClose").addEvent("click",function(a){a.stop();b.addClass("Hide")})}},onFailure:function(){}})).send();var l=$("J_boxWidget");
if(l){l.getPosition();var m=l.getElement(".J_btnLike"),t=$("J_barWidget"),I=t.getElement(".J_conWidget");if(m){var D=m.getPosition(l),u=m.getSize();if("closed"!==Cookie.read("likeTips")){var v=(new Element("div",{"class":"new-guide J_boxTips",html:'<div class="guide-con"><div class="guide-txt">发现内容不错或有用，就赞一下吧！LZ会很开心的！</div><span class="guide-arrow"></span><a href="javascript:void(0);" title="" class="close J_btnClose"></a></div>'})).inject(m,"after"),c=v.getElement(".J_btnClose"),d=v.getSize();v.setStyles({left:D.x-
(d.x-u.x)/2+60+"px",top:u.y+16+"px"});Cookie.write("likeTips","ignored",{duration:90});c.addEvent("click",function(a){a.stop();v.destroy();Cookie.write("likeTips","closed",{duration:90})})}m.addEvent("click",function(a){a.stop();var e=this;(new Request.JSON({url:"/ajax/noteLike",method:"POST",data:{noteId:b.data("noteId")},onSuccess:function(a){var b=a&&a.code;if(200==b||502==b){200==b&&((b=m.getElement(".J_numLike"))?b.set("text",a.likeCount):e.getElement("span").set("html",'赞(<em class="J_numLike">1</em>)'));
e.getSiblings(".J_tipsLike")[0]&&e.getSiblings(".J_tipsLike")[0].destroy();var c=(new Element("div",{"class":"pop-info J_tipsLike",style:"position:absolute; left:64px; top:32px;",html:'<div class="pop-succ"><span><i class="icon-succ"></i>'+a.msg+"</span></div>"})).inject(e,"after"),a=c.getSize();c.setStyles({position:"absolute",left:D.x-(a.x-u.x)/2+"px",top:u.y+2+"px"});setTimeout(function(){c.fade("out")},2E3)}else 100==b&&A("要点赞")},onFailure:function(){}})).send()})}Browser.ie&&6>=Browser.version||
window.addEvent("scroll",function(){150<this.getScroll().y?(t.removeClass("Hide"),l.inject(I)):(t.addClass("Hide"),l.inject(t,"before"))})}var x=$("J_topic_list").getElements(".J_card"),J=b.data("jVcard");x.length&&x.removeEvents("mouseover").addEvent("mouseover",function(a){a.stop();var b=$(this);$LAB.script(J).wait(function(){x.removeEvents("mouseover");b.fireEvent("mouseenter")})});var c=$("dpEditor"),y=b.data("jEditor");if(c&&y){var K=b.data("jUpload"),L=b.data("jSortable"),M=b.data("jHandlers"),
n=function(){var a=window.getSize().y,b=window.getScrollSize().y;window.getScroll().y>b-a-600&&$LAB.script(y).wait(function(){page.editor=(new nicEditor).panelInstance("dpEditor").selectedInstance;window.removeEvent("scroll",n).removeEvent("resize",n)}).script(K).script(L).script(M)};window.removeEvent("scroll").removeEvent("resize").addEvents({scroll:n,resize:n});window.getSize().y===window.getScrollSize().y-window.getScroll().y&&window.fireEvent("scroll",n)}if(c=$("J_boxWidget"))(c=c.getElement(".J_btnReply"))&&
c.addEvent("click",function(a){a.stop();A("要回帖",function(){pageTracker._trackPageview("dp_club_group_content_add");var a=location.href;a.test(/\#NoteAdd/g)||(a+="#NoteAdd");location.href=a;y?$LAB.wait(n).wait(function(){page.editor.focus()}):location.reload()})});var o=$$(".J_btnShare")[0],N=b.data("jShare"),E=function(){$LAB.script(N).wait(function(){o.removeEvent("mouseover",E);new b.SShare({$button:o});o.getParent("span").getNext(".J_boxShare").removeClass("Hide");o.getParent("span").getNext(".J_boxShare").fireEvent("mouseenter")})};
o&&o.addEvent("mouseover",E);var q=$$(".J_btnCollect")[0],O=b.data("jCollect"),F=function(){$LAB.script(O).wait(function(){q.removeEvent("mouseenter",F);new b.SCollect({$button:q});q.fireEvent("click")})};q&&q.addEvent("mouseenter",F);c=b.data("needGuide");d=b.data("jGuide");c&&$LAB.script(d).wait(function(){b.GuideRequest(0)});if(b.data("isOfficial")){var P=b.data("cReward"),Q=b.data("jReward");window.addEvent("load",function(){$LAB.wait(function(){(new Element("link",{type:"text/css",rel:"stylesheet",
href:P})).inject($(document).getElement("head"))}).script(Q).wait(function(){Egg.init({ugcValidateCode:b.data("ugcValidateCode"),bizId:6,subBizId:3})})})}var r=$("J_editorRecommend");r&&(c=r.getElement("ul"),d=c.getElements("li"),d.forEach(function(a){a.set("data-random",Math.random())}),d=d.sort(function(a,b){return Number(a.get("data-random"))-Number(b.get("data-random"))}),c.empty().adopt(d),b.Switch&&(new b.Switch).plugin("carousel","lazyLoad","endless","autoPlay").init({selectorPre:".J_editorRecommendBox",
events:{afterInit:function(){this.items.forEach(function(a,b){a.css("position","absolute").css("left",178*b)});var a=r.getElement(".J_prev"),b=r.getElement(".J_next");r.addEvents({mouseenter:function(c){c.stop();a.removeClass("Hide");b.removeClass("Hide")},mouseleave:function(c){c.stop();a.addClass("Hide");b.addClass("Hide")}})}},container:".J_editorRecommendContainer ul",items:"li",itemSpace:178,move:1,stage:1,prev:".J_prev",next:".J_next",interval:3500,hoverStop:!0,fx:{duration:300}}));var p=$("J_splendidEditor");
if(p){var d=p.getSize(),c=d.x,d=d.y,R=p.getPosition().y,G=(new Element("div",{"class":"Hide",style:"width:"+c+"px; height:"+d+"px;"})).inject(p,"after"),c=function(){if(z.getScroll().y>R-80){G.removeClass("Hide");p.addClass("splendid-editor-fixed")}else{G.addClass("Hide");p.removeClass("splendid-editor-fixed")}};c();z.addEvents({scroll:c,resize:c})}var k=$("btnAdd"),s=function(){k.removeEvents("click");for(var a=page.editor,c=a.getContent(),d=a.frameDoc.body.getElementsByTagName("img"),f=[],a=$("txtValidateCode")?
$("txtValidateCode").value:"",i,g=0,h=d.length;g<h;g++)d[g].getAttribute("data-picid")&&f.push(d[g].getAttribute("data-picid"));d=f.join();if($("txtValidateCode")){if(a.trim().length===0){$("errorValidateCode").set("html","请输入验证码！");k.addEvent("click",s);return false}$("errorValidateCode").set("html","")}if(page.editor.hasContent(0,15728640)){var j=$("J_note_preview"),f=j.get("data-quotetype")||"",g=j.get("data-quotepichtml")||"",h=j.get("data-quoteuuserid")||"",c="noteId="+b.data("noteId")+"&groupId="+
b.data("groupId")+"&noteBody="+c.cnEncode()+"&picIds="+d+"&validateCode="+a+"&quoteType="+($("J_pre_check").checked?f:"")+"&quotePicUrl="+($("J_pre_check").checked?g:"")+"&quotePicUserId="+($("J_pre_check").checked?h:"")+"&quoteNoteId="+($("J_pre_check").checked&&page._followNodeMain&&page._followNodeId?page._followNodeId:"")+"&quoteFollowNoteId="+($("J_pre_check").checked&&!page._followNodeMain&&page._followNodeId?page._followNodeId:"");(new AjaxReq({url:"/ajax/json/group/note/follownote/add",method:"post",
data:c,onRequest:function(){$("followNoteAddValidator").set("html","正在生成回应,请稍候...").className="Color10"},onError:function(){k.addEvent("click",s);$("followNoteAddValidator").set("html","添加失败，请重试").className="Color4"},onSuccess:function(a){k.addEvent("click",s);if(a&&a.code==200){j.removeProperties("data-quotetype","data-quotepicurl","data-quoteuuserid");$("followNoteAddValidator").set("html","").className="Color10";if(a.msg.isAudit)(new Prompt).alert(["提示","<p>应用管理需求，目前帖子应用先审后发。您的帖子已提交成功，我们会尽快审核。请耐心等待！</p>"],
{btnStyle:{width:"70px"},boxStyles:{width:"400px"},closable:false,onReturn:function(){}});else try{if(a.msg.full)PAGE_DATA[a.msg.full.key]=a.msg.full.value;$("J_topic_list").appendHTML(a.msg["short"]);page._followNodeMain=false;page._followNodeId=null;$("J_note_preview").getParent().addClass("Hide")}catch(b){$("followNoteAddValidator").set("html","添加失败，请重试").className="Color4";return false}page.followNoteClean();if(a&&a.msg&&a.msg.anniversaryData&&a.msg.anniversaryData.ugcValidateCode){var c=a.msg.anniversaryData;
Egg.init({ugcValidateCode:c.ugcValidateCode,bizId:c.bizId,subBizId:c.subBizId})}a.msg.needGuide&&DP.GuideRequest(1)}else $("followNoteAddValidator").set("html",a.msg||"").className="Color4";try{if(i=$$(".mcImg")[0])i.src="/JValidateCode.jpg?xx="+Math.floor(Math.random()*1001)}catch(d){}}})).send()}else{$("followNoteAddValidator").set("html","回应内容应大于0小于15k个字符!").className="Color4";k.addEvent("click",s);return false}};k&&k.addEvent("click",s)})})(DP);
