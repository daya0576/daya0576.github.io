(function(h){function u(a){a=a||"";switch(a){case "delete":a="删除好友";break;case "add":a="加好友"}h.authBox(a,"","follow")}function v(a){var f=e.getSize(),b=a.getSize(),a=a.getPosition(),c={},d={},i;k.t(a)&&0!==a.x?(i="b",c={left:a.x-b.x/4,top:a.y-f.y},d={left:b.x/2,top:l,bottom:0}):k.b(a,b)?(i="t",c={left:a.x-b.x/4,top:a.y+b.y+m},d={left:b.x/2,top:-6,buttom:l}):k.r(a,b)?(i="l",c={left:a.x+b.x+w/2},d={left:-6,right:l},k.t(a)?(c.top=a.y+b.y+b.y/2-f.y,d.top=f.y-b.y):(c.top=a.y,d.top=b.y/2)):k.l(a,b)?(i=
"r",c={left:a.x-n},d={right:-6,left:l},a.y-window.getScrollTop()>x?(c.top=a.y-f.y+b.y+m,d.top=f.y-b.y-m,0>d.top&&(d.top=1)):(c.top=a.y,d.top=b.y/2-m/2)):(i="l",c={left:a.x+b.x+w/2,top:a.y},d={top:b.y/2,left:-6,right:l});e.setStyles(c);z.set("class",A.substitute({pos:i})).setStyles(d)}function j(){o&&(clearTimeout(o),o=null)}function B(a){a.addEvents({mouseenter:function(){var a=this;j();o=setTimeout(function(){C&&C.mv("v_u_c",1);var b=a.get(q)||0,c=r[b],d;c?(p.set("html",c),v(a)):(e.store(q,b),p.set("html",
D),d=p.getElement(g+E),s&&s.cancel(),s=(new y({url:t+"/member/jsonp/userCarte",callbackKey:"callback",data:{rand:1E3*Math.random(),memberId:b},onRequest:function(){d.set("html","正在加载,请稍候...")},onError:function(){d.set("html","网络繁忙,请稍后再试")},onSuccess:function(c){s=null;if(c&&200==c.code){if(F){var e;e=c.msg;var g=new Element("div",{html:e}),h=g.getElements(".badge_show img");h.length&&(h.forEach(function(a){(new Element("span")).set("title",a.title).setStyles({height:37,width:37,filter:"progid:DXImageTransform.Microsoft.AlphaImageLoader(src="+
a.src+', sizingMethod="scale")',zoom:1,cursor:"pointer"}).replaces(a)}),e=g.innerHTML);c.msg=e}r[b]=c.msg;p.set("html",c.msg);v(a)}else d.set("html","系统繁忙,请稍后再试")}})).send());v(a);e.setStyles({visibility:"visible"});j()},300)},mouseleave:function(){j();o=setTimeout(function(){e.setStyles({visibility:"hidden"});j()},300)}})}var C=document.hippo,F=Browser.ie&&6==Browser.version,y=h.JSONP,g=".",m=12,w=15,x=223+m,n=333+w,r={},s,t,l="auto",E="J_load",q="user-id",A="J_arrow poparrow arrow-{pos}",D='<div class="'+
E+'">正在加载,请稍候...</div><div class="cartebg"></div>',G='<div class="pop_carte"><div class="cartebg_top"></div><div class="cartecont J_cont">'+D+'</div><div class="cartebg_botm"></div><span class="'+A.substitute({pos:"b"})+'"></span></div>',k={t:function(a){return a.y-window.getScrollTop()>x&&window.getWidth()+window.getScrollLeft()-a.x>n},b:function(a,e){return window.getScrollTop()+window.getHeight()-a.y-e.y>x&&window.getWidth()+window.getScrollLeft()-a.x>n&&0!==a.x},r:function(a,e){return window.getWidth()+
window.getScrollLeft()-a.x-e.x>n},l:function(a){return a.x-window.getScrollLeft()>n}},H={add:function(a){if(!a.retrieve("run")){var f=e.retrieve(q),b=a.getParent(".photo_infor"),c=b.getElement(g+"J_btn"),d=b.getElement(".photo");a.store("run",!0);pageTracker._trackPageview("dp_mingpian_follow");(new y({url:t+"/member/jsonp/followUser",callbackKey:"callback",data:{rand:1E3*Math.random(),memberId:f},onRequest:function(){c.removeClass("micro-btn").addClass("micro-btn-ash")},onError:function(){c.addClass("micro-btn").removeClass("micro-btn-ash");
a.store("run",!1)},onSuccess:function(b){a.store("run",!1);b&&200==b.code?(delete r[f],c.getElement("a").set("text","删除好友").set("title","删除好友").set("event-type","delete"),d.adopt(new Element("p",{html:'<i></i>&nbsp;已是好友<span class="friendbg"></span>'}))):b&&100==b.code?u("add"):c.addClass("micro-btn").removeClass("micro-btn-ash")}})).send()}},"delete":function(a){a=a.getParent(".photo_infor");a.getElement(g+"pop-delete-box")||a.adopt(new Element("div",{html:'<p>{msg}</p><p><span class="micro-btn"><a href="javascript:;" title="确定" event-type="pop-ok" class="btn-txt">确定</a></span><span class="micro-btn-ash"><a href="javascript:;" title="取消" event-type="pop-cancel" class="btn-txt">取消</a></span></p>'.substitute({msg:"你确定要删除好友吗？"}),
"class":"pop-delete-box"}))},"pop-ok":function(a){if(!a.retrieve("run")){var f=e.retrieve(q),b=a.getParent(".photo_infor"),c=b.getElement(g+"J_btn"),d=b.getElement(".photo p");a.store("run",!0);a.getParent(g+"pop-delete-box").destroy();pageTracker._trackPageview("dp_mingpian_unfollow");(new y({url:t+"/member/jsonp/unfollowUser",callbackKey:"callback",data:{rand:1E3*Math.random(),memberId:f},onRequest:function(){c.removeClass("micro-btn").addClass("micro-btn-ash")},onError:function(){c.addClass("micro-btn").removeClass("micro-btn-ash");
a.store("run",!1)},onSuccess:function(b){$(a).store("run",!1);b&&200==b.code?(delete r[f],c.getElement("a").set("text","加为好友").set("title","加为好友").set("event-type","add"),c.addClass("micro-btn").removeClass("micro-btn-ash"),d&&d.destroy()):b&&100==b.code&&u("delete")}})).send()}},"pop-cancel":function(a){a.getParent(g+"pop-delete-box").destroy()}},z,p,e,o;e=new Element("div",{html:G,styles:{position:"absolute",visibility:"hidden","z-index":3E3}});window.addEvent("domready",function(){var a=$$(".J_card");
t=h.data("jsonp-domain")||"http://www.dianping.com";z=e.getElement(g+"J_arrow");p=e.getElement(g+"J_cont");$(document.body).grab(e);a.forEach(function(a){B(a)});e.addEvents({mouseenter:function(){j();e.setStyles({visibility:"visible"})},mouseleave:function(){j();e.setStyles({visibility:"hidden"})},click:function(a){var b=a.target,c=b.get("event-type"),d=H[c];d&&(a.stop(),(new AjaxReq({url:"/ajax/json/account/info",data:{r:+new Date},onSuccess:function(a){a&&200==a.code?d(b):(e.setStyles({visibility:"hidden"}),
u(c))}})).send())}})});h.Widget=h.Widget||{};h.Widget.vCard=B})(DP);
