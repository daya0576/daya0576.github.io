(function(f){function h(a,b,c){var d=(new Element("div")).addClass(c.elemCls||""),a=(new Element("div")).set("html",a).addClass(c.titleCls||"dialog-title"),b=(new Element("div")).set("html",b).addClass(c.contCls||"dialog-cont");d.adopt(a);d.adopt(b);return{elem:d,title:a,cont:b}}var g=function(a){this.options=DP.mix({title:"",indexCS:"",detailUrl:"",rewardCsMap:{}},a)};g.prototype={init:function(a){var b=this,a=a||DP.data("rewardData")||{};(new AjaxReq({method:"post",data:a,url:"/ajax/json/goldegg/winning",
onSuccess:function(a){var d;200==a.code&&(a=a.msg,a.isWinning&&(b.picroot=a.picroot,d=b.indexhtml=a.indexhtml,delete a.isWinning,delete a.picroot,delete a.indexhtml,b.dataInfo=a,b.open(d)))}})).send()},open:function(a){var b=this,a=h(b.options.title,'<div class="breakegg">'+a+"</div>",{elemCls:"index_layer",titleCls:"egg_tit",contCls:"egg_cont"});b.box=f.mbox.open({url:a.elem,closable:!0,winCls:"eggs-win pop-win "+b.options.indexCS,overlay:!1,size:{x:630,y:310},zIndex:2004});var c=b.content=a.cont,
d=b.captcha=c.getElement(".J_captcha"),e=b.captchaInput=c.getElement(".J_captchaInput"),g=c.getElement(".J_submit"),j=c.getElements(".J_change,.J_captcha"),i=c.getElement(".J_details");a.elem.setStyle("background-image","url(http://www.dianping.com/events/goldeneggs/"+b.picroot+"/bg_index"+(d?"":"_nocaptcha")+".jpg)");i&&i.set("href",b.options.detailUrl);j.addEvent("click",b.changeCaptcha.bind(b));g.addEvent("click",b.verifyCaptcha.bind(b));d?(e.addEvent("keyup",function(a){"enter"==a.key&&(e.set("disabled",
!0),b.verifyCaptcha())}),d.addEvent("click",b.changeCaptcha.bind(b)),b.changeCaptcha()):c.addClass("nocaptcha")},close:function(){this.box.close();return!1},verifyCaptcha:function(){var a=this,b,c=a.captchaInput;err=a.content.getElement(".err");if(c)if(b=c.get("value"))b=DP.mix(a.dataInfo,{txtValidateCode:b});else{err&&err.set("html","请先输入验证码");a.captchaInput.set("disabled",!1);a.captchaInput.focus();return}else b=a.dataInfo;(new AjaxReq({method:"post",data:b,url:"/ajax/json/goldegg/receive",onSuccess:function(b){c&&
c.set("disabled",!1);"200"==b.code?a.getReward(b.msg):"500"==b.code?(err&&err.set("html",b.msg),a.changeCaptcha()):"501"==b.code&&(a.close(),f.mbox.open({url:h("已领过奖","您今天已经领过奖品，无法重复领取，谢谢您对大众点评的支持 :)").elem,size:{x:400}}))}})).send();return!1},changeCaptcha:function(){this.captcha&&(this.captcha.set("src","/goldeggValidateCode.jpg?t="+ +new Date),this.captchaInput.set("value","").focus());return!1},getReward:function(a){var b="http://www.dianping.com/events/goldeneggs/"+this.picroot+"/"+a.picurl,
c="http://www.dianping.com/events/goldeneggs/"+this.picroot+"/bg.png",a=a.message,d=this.content,e=(new Element("div")).addClass("egg_cont_inner");$$(".eggs-win").setStyles({width:637,height:297});this.box.content.getElement(".index_layer").removeClass("index_layer").addClass("egg_layer").setStyle("background-image","url("+c+")");d.empty();e.set("html",a.replace("{link}",this.options.detailUrl));e.inject(d);e.setStyle("background-image","url("+b+")")}};f.Widget.Reward=g})(DP);(function(f){f.Egg=new DP.Widget.Reward})(window);
