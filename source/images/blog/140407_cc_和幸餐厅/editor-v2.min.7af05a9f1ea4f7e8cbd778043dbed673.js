var bkExtend=function(){var a=arguments;1==a.length&&(a=[this,a[0]]);for(var b in a[1])a[0][b]=a[1][b];return a[0]};function bkClass(){}bkClass.prototype.construct=function(){};bkClass.extend=function(a){var b=function(){if(arguments[0]!==bkClass)return this.construct.apply(this,arguments)},c=new this(bkClass);bkExtend(c,a);b.prototype=c;b.extend=this.extend;return b};
var bkElement=bkClass.extend({construct:function(a,b){"string"==typeof a&&(a=(b||document).createElement(a));return a=$BK(a)},appendTo:function(a){a.appendChild(this);return this},appendBefore:function(a){a.parentNode.insertBefore(this,a);return this},addevent:function(a,b){bkLib.addEvent(this,a,b);return this},setContent:function(a){this.innerHTML=a;return this},pos:function(){var a=curtop=0;obj=this;if(obj.offsetParent){do a+=obj.offsetLeft,curtop+=obj.offsetTop;while(obj=obj.offsetParent)}var b=
!window.opera?parseInt(this.getstyle("border-width")||this.style.border)||0:0;return[a+b,curtop+b+this.offsetHeight]},noSelect:function(){bkLib.noSelect(this);return this},hasclass:function(a){return this.className.match(RegExp("(\\s|^)nicEdit-"+a+"(\\s|$)"))},addclass:function(a){this.hasclass(a)||(this.className+=" nicEdit-"+a);return this},removeclass:function(a){this.hasclass(a)&&(this.className=this.className.replace(RegExp("(\\s|^)nicEdit-"+a+"(\\s|$)")," "));return this},setstyle:function(a){var b=
this.style,c;for(c in a)switch(c){case "float":b.cssFloat=b.styleFloat=a[c];break;case "opacity":b.opacity=a[c];b.filter="alpha(opacity="+Math.round(100*a[c])+")";break;case "className":this.className=a[c];break;default:b[c]=a[c]}return this},getstyle:function(a,b){var c=!b?document.defaultView:b;if(1==this.nodeType)return c&&c.getComputedStyle?c.getComputedStyle(this,null).getPropertyValue(a):this.currentStyle[bkLib.camelize(a)]},remove:function(){this.parentNode.removeChild(this);return this},setattributes:function(a){for(var b in a)this[b]=
a[b];return this}}),bkLib={browser:function(){var a=navigator.userAgent.toLowerCase();return{VERSION:a.match(/(msie|firefox|webkit|opera)[\/:\s](\d+)/)?RegExp.$2:"0",IE:-1<a.indexOf("msie")&&-1==a.indexOf("opera"),GECKO:-1<a.indexOf("gecko")&&-1==a.indexOf("khtml"),WEBKIT:-1<a.indexOf("applewebkit"),OPERA:-1<a.indexOf("opera")}}(),addEvent:function(a,b,c){a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent("on"+b,c)},toArray:function(a){for(var b=a.length,c=Array(b);b--;)c[b]=a[b];return c},
inArray:function(a,b){return null!=bkLib.search(a,b)},search:function(a,b){for(var c=0;c<a.length;c++)if(a[c]==b)return c;return null},eraseArray:function(a,b){for(var c=b.length;c--;c)b[c]===a&&b.splice(c,1);return b},noSelect:function(a){a.setAttribute&&("input"!=a.nodeName.toLowerCase()&&"textarea"!=a.nodeName.toLowerCase())&&a.setAttribute("unselectable","on");for(var b=0;b<a.childNodes.length;b++)bkLib.noSelect(a.childNodes[b])},camelize:function(a){return a.replace(/\-(.)/g,function(a,c){return c.toUpperCase()})},
cancelEvent:function(a){a=a||window.event;a.preventDefault&&a.stopPropagation?(a.preventDefault(),a.stopPropagation()):(a.returnValue=!1,a.cancelBubble=!0);return!1},util:{setting:{noEndTags:"br hr img area col embed input param".split(" ")},$:function(a,b){b=b||document;return b.getElementById(a)},$$:function(a,b){b=b||document;return b.createElement(a)},createRange:function(a){return a.createRange?a.createRange():a.body.createTextRange()},moveToElementText:function(a,b){a.moveToElementText(b)},
getNodeStartRange:function(a,b){var c=bkLib.util.createRange(a),d=b.nodeType;if(1==d)return bkLib.util.moveToElementText(c,b),c;if(3==d){for(var d=0,e=b.previousSibling;e;){if(1==e.nodeType){var h=bkLib.util.createRange(a);bkLib.util.moveToElementText(h,e);c.setEndPoint("StartToEnd",h);c.moveStart("character",d);return c}3==e.nodeType&&(d+=e.nodeValue.length);e=e.previousSibling}bkLib.util.moveToElementText(c,b.parentNode);c.moveStart("character",d);return c}},getNodeTextLength:function(a){var b=
bkLib.util.getNodeType(a);if(1==b)return a.innerHTML.replace(/<.*?>/ig,"").length;if(3==b)return a.nodeValue.length},getNodeType:function(a){return 1==a.nodeType&&bkLib.util.inArray(a.tagName.toLowerCase(),bkLib.util.setting.noEndTags)?88:a.nodeType},inArray:function(a,b){for(var c=0;c<b.length;c++)if(a==b[c])return!0;return!1},arrayToHash:function(a){for(var b={},c=0,d=a.length;c<d;c++)b[a[c]]=1;return b},eachNode:function(a,b){var c=function(a){if(1!=bkLib.util.getNodeType(a))return!0;for(a=a.firstChild;a;){var e=
a.nextSibling;if(!b(a)||!c(a))return!1;a=e}return!0};c(a)},each:function(a,b){for(var c in a)a.hasOwnProperty(c)&&b(c,a[c])},getJsKey:function(a){for(var b=a.split("-"),a="",c=0,d=b.length;c<d;c++)a+=0<c?b[c].charAt(0).toUpperCase()+b[c].substr(1):b[c];return a},removeParent:function(a){if(a.hasChildNodes)for(var b=a.firstChild;b;){var c=b.nextSibling;a.parentNode.insertBefore(b,a);b=c}a.parentNode.removeChild(a)},getAttrList:function(a){for(var b=/\s+(?:([\w-:]+)|(?:([\w-:]+)=([\w-:]+))|(?:([\w-:]+)="([^"]*)")|(?:([\w-:]+)='([^']*)'))(?=(?:\s|\/|>)+)/g,
c,d,e={};c=b.exec(a);)d=c[1]||c[2]||c[4]||c[6],c=c[1]||(c[2]?c[3]:c[4]?c[5]:c[7]),e[d]=c;return e},innerHtml:function(a,b){if(bkLib.browser.IE){a.innerHTML='<img id="__ke_temp_tag__" width="0" height="0" />'+b;var c=bkLib.util.$("__ke_temp_tag__",a.ownerDocument);c&&c.parentNode.removeChild(c)}else a.innerHTML=b},pasteHtml:function(a,b,c){b=c?'<img id="__ke_temp_tag__" width="0" height="0" />'+b:b+'<img id="__ke_temp_tag__" width="0" height="0" />';bkLib.browser.IE?a.range.item?a.range.item(0).outerHTML=
b:a.range.pasteHTML(b):(a.range.deleteContents(),b=a.range.createContextualFragment(b),a.range.insertNode(b));b=bkLib.util.$("__ke_temp_tag__",a.frameDoc);c=a.frameDoc.createTextNode("");b.parentNode.replaceChild(c,b);a.keRange.selectNode(c);a.keSel.addRange(a.keRange)},insertHtml:function(a,b){if(""!==b&&a.range)if(bkLib.browser.IE)if(this.select(a),a.range.item)try{a.range.item(0).outerHTML=b}catch(c){var d=a.range.item(0),e=d.parentNode;e.removeChild(d);"body"!=e.nodeName.toLowerCase()&&(e=e.parentNode);
this.innerHtml(e,b+e.innerHTML)}else a.range.pasteHTML(b);else bkLib.browser.GECKO&&3>bkLib.browser.VERSION?a.frameDoc.execCommand("inserthtml",!1,b):this.pasteHtml(a,b)},setSelection:function(a){var b=new bkLib.selection(a.frameDoc);if(!bkLib.browser.IE||b.range.item||b.range.parentElement().ownerDocument===a.frameDoc)a.keSel=b,a.keRange=a.keSel.keRange,a.sel=a.keSel.sel,a.range=a.keSel.range},select:function(a){bkLib.browser.IE&&a.range&&a.range.select()}},range:function(a){this.endPos=this.endNode=
this.startPos=this.startNode=null;this.getParentElement=function(){var b=function(a,b){for(;a&&(!a.tagName||"body"!=a.tagName.toLowerCase())&&!(a=a.parentNode,b(a)););},c=[];b(this.startNode,function(a){c.push(a)});var d;b(this.endNode,function(a){if(bkLib.util.inArray(a,c))return d=a,!0});return d?d:a.body};this.getNodeList=function(){var b=this,c=this.getParentElement(),d=[],e=!1;c==b.startNode&&(e=!0);e&&d.push(c);bkLib.util.eachNode(c,function(c){c==b.startNode&&(e=!0);var f=new bkLib.range(a);
f.selectTextNode(c);var g=f.comparePoints("START_TO_END",b);if(0<g||0==g&&(f.startNode!==f.endNode||f.startPos!==f.endPos))return!1;e&&d.push(c);return!0});return d};this.comparePoints=function(b,c){var d=function(c,d,f,g){if(bkLib.browser.IE){var i=function(b,c,d){var e=bkLib.util.createRange(a),g=bkLib.util.getNodeType(b);1==g?(bkLib.util.moveToElementText(e,b),e.collapse(d)):3==g&&(e=bkLib.util.getNodeStartRange(a,b),e.moveStart("character",c),e.collapse(!0));return e},l;l="START_TO_START"==b||
"START_TO_END"==b?i(c,d,!0):i(c,d,!1);c="START_TO_START"==b||"END_TO_START"==b?i(f,g,!0):i(f,g,!1);return l.compareEndPoints("StartToStart",c)}l=bkLib.util.createRange(a);l.selectNode(c);"START_TO_START"==b||"START_TO_END"==b?l.collapse(!0):l.collapse(!1);c=bkLib.util.createRange(a);c.selectNode(f);"START_TO_START"==b||"END_TO_START"==b?c.collapse(!0):c.collapse(!1);return 0<l.compareBoundaryPoints(Range.START_TO_START,c)?1:0==l.compareBoundaryPoints(Range.START_TO_START,c)?d>g?1:d==g?0:-1:-1};if("START_TO_START"==
b)return d(this.startNode,this.startPos,c.startNode,c.startPos);if("START_TO_END"==b)return d(this.startNode,this.startPos,c.endNode,c.endPos);if("END_TO_START"==b)return d(this.endNode,this.endPos,c.startNode,c.startPos);if("END_TO_END"==b)return d(this.endNode,this.endPos,c.endNode,c.endPos)};this.collapsed=function(){return this.startNode===this.endNode&&this.startPos===this.endPos};this.collapse=function(a){a?this.setEnd(this.startNode,this.startPos):this.setStart(this.endNode,this.endPos)};this.setTextStart=
function(a,c){var d=a;bkLib.util.eachNode(a,function(a){return 3==bkLib.util.getNodeType(a)&&0<a.nodeValue.length||88==bkLib.util.getNodeType(a)?(d=a,c=0,!1):!0});this.setStart(d,c)};this.setStart=function(a,c){this.startNode=a;this.startPos=c;null===this.endNode&&(this.endNode=a,this.endPos=c)};this.setTextEnd=function(a,c){var d=a;bkLib.util.eachNode(a,function(a){if(3==bkLib.util.getNodeType(a)&&0<a.nodeValue.length||88==bkLib.util.getNodeType(a))d=a,c=3==bkLib.util.getNodeType(a)?a.nodeValue.length:
0;return!0});this.setEnd(d,c)};this.setEnd=function(a,c){this.endNode=a;this.endPos=c;null===this.startNode&&(this.startNode=a,this.startPos=c)};this.selectNode=function(a){this.setStart(a,0);this.setEnd(a,1==a.nodeType?0:a.nodeValue.length)};this.selectTextNode=function(a){this.setTextStart(a,0);this.setTextEnd(a,1==a.nodeType?0:a.nodeValue.length)};this.extractContents=function(b){var b=void 0===b?!0:b,c=this,d=this.startNode,e=this.startPos,h=this.endNode,f=this.endPos,g=function(a,c,d){var e=
a.nodeValue.length,g=a.cloneNode(!0).splitText(c);g.splitText(d-c);if(b){var k=a;0<c&&(k=a.splitText(c));d<e&&k.splitText(d-c);k.parentNode.removeChild(k)}return g},i=bkLib.util.arrayToHash(bkLib.util.setting.noEndTags),l=!1,n=!1,m=function(k,p){if(1!=bkLib.util.getNodeType(k))return!0;for(var j=k.firstChild;j;){j==d&&(l=!0);j==h&&(n=!0);var q=j.nextSibling,o=j.nodeType;if(1==o)if(o=new bkLib.range(a),o.selectNode(j),o=o.comparePoints("END_TO_END",c),l&&(0>o||0==o&&void 0!==i[j.nodeName.toLowerCase()]))o=
j.cloneNode(!0),p.appendChild(o),b&&j.parentNode.removeChild(j);else{if(o=j.cloneNode(!1),void 0===i[o.nodeName.toLowerCase()]&&(p.appendChild(o),!m(j,o)))return!1}else if(3==o&&l){if(j==d&&j==h)return j=g(j,e,f),p.appendChild(j),!1;if(j==d)j=g(j,e,j.nodeValue.length);else{if(j==h)return j=g(j,0,f),p.appendChild(j),!1;j=g(j,0,j.nodeValue.length)}p.appendChild(j)}j=q;if(n)return!1}""===p.innerHTML.replace(/<.*?>/g,"")&&p.parentNode&&p.parentNode.removeChild(p);return!0},k=this.getParentElement(),q=
k.cloneNode(!1);m(k,q);return q};this.cloneContents=function(){return this.extractContents(!1)};this.getText=function(){return this.cloneContents().innerHTML.replace(/<.*?>/g,"")}},selection:function(a){var b=a.parentWindow||a.defaultView;this.keRange=this.range=this.sel=null;this.isControl=!1;this.init=function(){var c=b.getSelection?b.getSelection():a.selection,d;try{d=0<c.rangeCount?c.getRangeAt(0):c.createRange()}catch(e){}d||(d=bkLib.util.createRange(a));this.sel=c;this.range=d;var h,f,g;if(bkLib.browser.IE)d.item?
(this.isControl=!0,c=f=d.item(0),h=g=0):(this.isControl=!1,c=function(b){var c=d.duplicate();c.collapse(b);var e=c.parentElement(),g=e.childNodes;if(0==g.length)return{node:e,pos:0};var f,h=0,i=!1,j=d.duplicate();bkLib.util.moveToElementText(j,e);for(var s=0,o=g.length;s<o;s++){var b=g[s],r=j.compareEndPoints("StartToStart",c);if(0<r)i=!0;else if(0==r)return 1==b.nodeType?(c=new bkLib.range(a),c.selectTextNode(b),{node:c.startNode,pos:0}):{node:b,pos:0};1==b.nodeType?(r=d.duplicate(),bkLib.util.moveToElementText(r,
b),j.setEndPoint("StartToEnd",r),h=i?h+r.text.length:0):3==b.nodeType&&(j.moveStart("character",b.nodeValue.length),h+=b.nodeValue.length);i||(f=b)}if(!i&&1==f.nodeType)return f=e.lastChild,{node:f,pos:1==f.nodeType?1:f.nodeValue.length};j=d.duplicate();bkLib.util.moveToElementText(j,e);j.setEndPoint("StartToEnd",c);h-=j.text.replace(/\r\n|\n|\r/g,"").length;return{node:f,pos:h}},h=c(!0),g=c(!1),c=h.node,h=h.pos,f=g.node,g=g.pos);else{c=d.startContainer;h=d.startOffset;f=d.endContainer;g=d.endOffset;
1==c.nodeType&&"undefined"!=typeof c.childNodes[h]&&(c=c.childNodes[h],h=0);1==f.nodeType&&(g=0==g?1:g,"undefined"!=typeof f.childNodes[g-1]&&(f=f.childNodes[g-1],g=1==f.nodeType?0:f.nodeValue.length));this.isControl=1==c.nodeType&&c===f&&d.startOffset+1==d.endOffset;if(1==c.nodeType&&3==f.nodeType&&0==g&&f.previousSibling)for(var i=f.previousSibling;i;){if(i===c){f=c;break}if(1!=i.childNodes.length)break;i=i.childNodes[0]}d.collapsed&&(i=new bkLib.range(a),i.setTextStart(c,h),f=i.startNode,g=i.startPos)}i=
new bkLib.range(a);i.setTextStart(c,h);i.setTextEnd(f,g);this.keRange=i};this.addRange=function(b){if(!(bkLib.browser.GECKO&&3>bkLib.browser.VERSION))if(this.keRange=b,bkLib.browser.IE){var d=function(d){var e=bkLib.util.createRange(a),f=d?b.startNode:b.endNode;1==f.nodeType?(bkLib.util.moveToElementText(e,f),e.collapse(d)):3==f.nodeType&&(e=bkLib.util.getNodeStartRange(a,f),e.moveStart("character",d?b.startPos:b.endPos));return e};if(!this.range.item){var e=b.startNode;e==b.endNode&&1==bkLib.util.getNodeType(e)&&
0==bkLib.util.getNodeTextLength(e)?(d=a.createTextNode(" "),e.appendChild(d),bkLib.util.moveToElementText(this.range,e),this.range.collapse(!1),this.range.select(),e.removeChild(d)):(3==e.nodeType&&b.collapsed()?this.range=d(!0):(this.range.setEndPoint("StartToStart",d(!0)),this.range.setEndPoint("EndToStart",d(!1))),this.range.select())}}else{e=function(a){for(var b=0;a;)a=a.previousSibling,b++;return--b};d=new bkLib.range(a);d.setTextStart(b.startNode,b.startPos);d.setTextEnd(b.endNode,b.endPos);
var h=d.startNode,f=d.endNode;88==bkLib.util.getNodeType(h)?this.range.setStart(h.parentNode,e(d.startNode)):this.range.setStart(h,d.startPos);88==bkLib.util.getNodeType(f)?this.range.setEnd(f.parentNode,e(d.endNode)+1):this.range.setEnd(f,d.endPos);this.sel.removeAllRanges();this.sel.addRange(this.range)}};this.focus=function(){bkLib.browser.IE&&null!=this.range&&this.range.select()};this.init()},cmd:function(a){this.doc=a.frameDoc;this.keSel=a.keSel;this.keRange=a.keRange;this.mergeAttributes=function(a,
c){for(var d=0,e=c.length;d<e;d++)bkLib.util.each(c[d],function(c,d){if("."==c.charAt(0)){var e=bkLib.util.getJsKey(c.substr(1));a.style[e]=d}else bkLib.browser.IE&&(8>bkLib.browser.VERSION&&"class"==c)&&(c="className"),a.setAttribute(c,d)});return a};this.wrapTextNode=function(a,c,d,e,h){var f=a.nodeValue.length,g=0==c&&d==f,i=new bkLib.range(this.doc);i.selectTextNode(a.parentNode);if(g&&a.parentNode.tagName==e.tagName&&0>=i.comparePoints("END_TO_END",this.keRange)&&0<=i.comparePoints("START_TO_START",
this.keRange))return this.mergeAttributes(a.parentNode,h),a;e=e.cloneNode(!0);if(g)return c=a.cloneNode(!0),e.appendChild(c),a.parentNode.replaceChild(e,a),c;g=a;if(c<d)return 0<c&&(g=a.splitText(c)),d<f&&g.splitText(d-c),c=g.cloneNode(!0),e.appendChild(c),g.parentNode.replaceChild(e,g),c;c<f?(g=a.splitText(c),g.parentNode.insertBefore(e,g)):g.nextSibling?g.parentNode.insertBefore(e,g.nextSibling):g.parentNode.appendChild(e);return e};this.getTopParent=function(a,c){for(var d=null;c;)if(c=c.parentNode,
bkLib.util.inArray(c.tagName.toLowerCase(),a))d=c;else break;return d};this.splitNodeParent=function(a,c,d){var e=new bkLib.range(this.doc);e.selectNode(a.firstChild);e.setEnd(c,d);c=e.extractContents();a.parentNode.insertBefore(c,a);return{left:c,right:a}};this.wrap=function(a,c){var c=c||[],d=this;this.keSel.focus();var e=bkLib.util.$$(a,this.doc);this.mergeAttributes(e,c);var h=this.keRange,f=h.startNode,g=h.startPos,i=h.endNode,l=h.endPos,n=h.getParentElement(),m=!1;bkLib.util.eachNode(n,function(a){a==
f&&(m=!0);if(1==a.nodeType){if(a==f&&a==i)return bkLib.util.inArray(a.tagName.toLowerCase(),bkLib.util.setting.noEndTags)?0<g?a.parentNode.appendChild(e):a.parentNode.insertBefore(e,a):a.appendChild(e),h.selectNode(e),!1;if(a==f)h.setStart(a,0);else if(a==i)return h.setEnd(a,0),!1}else if(3==a.nodeType&&m){if(a==f&&a==i)return a=d.wrapTextNode(a,g,l,e,c),h.selectNode(a),!1;if(a==f)a=d.wrapTextNode(a,g,a.nodeValue.length,e,c),h.setStart(a,0);else{if(a==i)return a=d.wrapTextNode(a,0,l,e,c),h.setEnd(a,
1==a.nodeType?0:a.nodeValue.length),!1;d.wrapTextNode(a,0,a.nodeValue.length,e,c)}}return!0});this.keSel.addRange(h)};this.remove=function(a){var c=this.keRange,d=c.startNode,e=c.startPos,h=c.endNode,f=c.endPos;this.keSel.focus();var g=""===c.getText().replace(/\s+/g,"");if(!g||bkLib.browser.IE){var i=[];bkLib.util.each(a,function(a){"*"!=a&&i.push(a)});var l=this.getTopParent(i,d),n=this.getTopParent(i,h);if(l){var m=this.splitNodeParent(l,d,e);c.setStart(m.right,0);d==h&&0<bkLib.util.getNodeTextLength(m.right)&&
(c.selectNode(m.right),d=new bkLib.range(this.doc),d.selectTextNode(m.left),0<e&&(f-=d.endNode.nodeValue.length),d.selectTextNode(m.right),h=d.startNode)}if(g)if(l=c.startNode,1==l.nodeType){if("br"==l.nodeName.toLowerCase())return;c.selectNode(l)}else return;else n&&(e=this.splitNodeParent(n,h,f),c.setEnd(e.left,0),l==n&&c.setStart(e.left,0));n=function(a,c){if("."==c.charAt(0)){var b=bkLib.util.getJsKey(c.substr(1));a.style[b]=""}else bkLib.browser.IE&&(8>bkLib.browser.VERSION&&"class"==c)&&(c=
"className"),a.removeAttribute(c)};e=c.getNodeList();c.setTextStart(c.startNode,c.startPos);c.setTextEnd(c.endNode,c.endPos);f=0;for(g=e.length;f<g;f++)if(l=e[f],1==l.nodeType){m=l.tagName.toLowerCase();if(a[m]){m=a[m];d=0;for(h=m.length;d<h;d++)if("*"==m[d]){bkLib.util.removeParent(l);break}else{n(l,m[d]);var k=[];l.outerHTML?(attrHash=bkLib.util.getAttrList(l.outerHTML),bkLib.util.each(attrHash,function(a,c){k.push({name:a,value:c})})):k=l.attributes;if(0==k.length){bkLib.util.removeParent(l);break}else if("style"==
k[0].name&&""===k[0].value){bkLib.util.removeParent(l);break}}}if(a["*"]){m=a["*"];d=0;for(h=m.length;d<h;d++)n(l,m[d])}}try{this.keSel.addRange(c)}catch(q){}}}}};function $BK(a){"string"==typeof a&&(a=document.getElementById(a));return a&&!a.appendTo?bkExtend(a,bkElement.prototype):a}
var bkEvent={addEvent:function(a,b){b&&(this.eventList=this.eventList||{},this.eventList[a]=this.eventList[a]||[],this.eventList[a].push(b));return this},fireEvent:function(){var a=bkLib.toArray(arguments),b=a.shift();if(this.eventList&&this.eventList[b])for(var c=0;c<this.eventList[b].length;c++)this.eventList[b][c].apply(this,a)}};Function.prototype.closure=function(){var a=this,b=bkLib.toArray(arguments),c=b.shift();return function(){if("undefined"!=typeof bkLib)return a.apply(c,b.concat(bkLib.toArray(arguments)))}};
Function.prototype.closureListener=function(){var a=this,b=bkLib.toArray(arguments),c=b.shift();return function(d){d=d||window.event;return a.apply(c,[d,d.target?d.target:d.srcElement].concat(b))}};
var nicEditorConfig=bkClass.extend({buttons:{bold:{name:"Bold",command:"Bold",tags:["B","STRONG"],css:{"font-weight":"bold"},key:"b"}},iconsPath:"http://i1.dpfile.com/s/img/editor/editor1.gif",bgPath:"http://i2.dpfile.com/s/img/editor/bg.gif",uploadFlashPath:"http://i3.dpfile.com/s/res/Upload2.swf",uploadServerPath:"",uploadSuccess:"",hasUpload:!0,hasEmotion:!0,style:"body{font-family: Arial; font-size:14px;padding:2px 10px;margin:0;line-height:22px;word-wrap: break-word; background:#fff;} p{padding: 0px; margin: 0px; }.quote{margin-left: 40px; margin-right:40px;\tpadding:5px; background-color: #F7F7F7; border:1px #AAA solid;font-size:12px;}.innerquote{margin-left: 5px;\tmargin-right:5; padding:5px; background-color: #F7F7F7; border:1px #AAA solid;font-size:12px;}.Content{overflow:hidden;table-layout:fixed;width:100%;} .btnPrint{background: url(/s/css/img/group/print.gif);width: 140px;height: 30px;display:block;}a.btnPrint:hover{background: url(/s/css/img/group/print.gif) 0px -30px;}",
buttonList:"bold fontSize forecolor upload insert small large".split(" "),iconList:{bold:1,fontSize:2,forecolor:3,upload:4,insert:5,large:6,small:7,emo1:8,emo2:9}}),nicEditors={nicPlugins:[],editors:[],registerPlugin:function(a,b){this.nicPlugins.push({p:a,o:b})},allTextAreas:function(a){for(var b=document.getElementsByTagName("textarea"),c=0;c<b.length;c++)nicEditors.editors.push((new nicEditor(a)).panelInstance(b[c]));return nicEditors.editors},findEditor:function(a){for(var b=nicEditors.editors,
c=0;c<b.length;c++)if(b[c].instanceById(a))return b[c].instanceById(a)}},nicEditor=bkClass.extend({construct:function(a){this.options=new nicEditorConfig;bkExtend(this.options,a);this.nicInstances=[];this.loadedPlugins=[];this.options.hasUpload||bkLib.eraseArray("upload",this.options.buttonList);for(var a=nicEditors.nicPlugins,b=0;b<a.length;b++)(this.options.hasEmotion||a[b].p!=nicEditorEmotion)&&this.loadedPlugins.push(new a[b].p(this,a[b].o));nicEditors.editors.push(this)},panelInstance:function(a,
b){var a=this.checkReplace($BK(a)),c=(new bkElement("DIV")).setstyle({width:(parseInt(a.getstyle("width"))||a.clientWidth)+"px"}).appendBefore(a);this.setPanel(c);return this.addInstance(a,b)},checkReplace:function(a){var b=nicEditors.findEditor(a);b&&(b.removeInstance(a),b.removePanel());return a},addInstance:function(a,b){var a=this.checkReplace($BK(a)),c=new nicEditorInstance(a,b,this);this.nicInstances.push(c);this.fireEvent("emotion",a);this.fireEvent("selected",this.selectedInstance);return this},
removeInstance:function(a){for(var a=$BK(a),b=this.nicInstances,c=0;c<b.length;c++)b[c].e==a&&(b[c].remove(),this.nicInstances.splice(c,1))},removePanel:function(){this.nicPanel&&(this.nicPanel.remove(),this.nicPanel=null)},instanceById:function(a){for(var a=$BK(a),b=this.nicInstances,c=0;c<b.length;c++)if(b[c].e==a)return b[c]},setPanel:function(a){this.nicPanel=new nicEditorPanel($BK(a),this.options,this);this.fireEvent("panel",this.nicPanel);return this},nicCommand:function(a,b){this.selectedInstance&&
this.selectedInstance.nicCommand(a,b)},getIcon:function(a,b){var c=this.options.iconList[a],d=b&&b.iconFiles?b.iconFiles[a]:"";return{backgroundImage:"url("+(c?this.options.iconsPath:d)+")",backgroundPosition:"emo1"==a||"emo2"==a?-100*(c-1)+"px 50%":-100*(c-1)+4+"px 50%",backgroundRepeat:"no-repeat"}},selectCheck:function(a,b){do if(b.className&&-1!=b.className.indexOf("nicEdit"))return!1;while(b=b.parentNode);this.fireEvent("blur",this.selectedInstance,b);this.lastSelectedInstance=this.selectedInstance;
this.selectedInstance=null;return!1},insertPic:function(a){bkLib.util.insertHtml(this.selectedInstance,a)},setUploadPath:function(a){a&&(this.options.uploadServerPath=a)}}),nicEditor=nicEditor.extend(bkEvent),nicEditorInstance=bkClass.extend({isSelected:!1,savedStyles:[],construct:function(a,b,c){this.ne=c;this.elm=this.e=a;this.options=b||{};newX=parseInt(a.getstyle("width"))||a.clientWidth;this.initialHeight=newY=parseInt(a.getstyle("height"))||a.clientHeight;if("textarea"==a.nodeName.toLowerCase()||
this.options.hasPanel)this.editorContain=(new bkElement("DIV")).setstyle({width:newX+"px",border:"1px solid #ccc",borderTop:0,overflow:"hidden",maxHeight:this.ne.options.maxHeight?this.ne.options.maxHeight+"px":null}).appendBefore(a),this.elmFrame=(new bkElement("IFRAME")).setattributes({frameBorder:0,allowTransparency:"true"}).setstyle({width:newX+"px",height:newY+"px",overflow:"auto"}).addclass("frame").appendTo(this.editorContain),this.copyElm=a,a.setstyle({display:"none"});this.ne.selectedInstance=
this;setTimeout(function(){this.elmFrame.contentWindow?this.init():arguments.callee.call(this)}.closure(this),0)},init:function(){var a;this.e.value?a=this.e.value.replace(/^\s+|\s+$/g,""):a="";this.initialContent=a;a=$BK(this.elmFrame.contentWindow.document);a.designMode="on";a.contentEditable=!0;a.open();a.write('<html><head><style type="text/css">'+this.ne.options.style+"</style></head><body>"+(this.initialContent?this.initialContent:bkLib.browser.IE?"":"<br>")+"</body></html>");a.close();this.frameDoc=
a;this.frameWin=$BK(this.elmFrame.contentWindow);this.frameContent=$BK(this.frameWin.document.body);bkLib.browser.IE?this.frameContent.addevent("mousedown",this.mouseDown.closureListener(this)):this.frameDoc.addevent("mousedown",this.mouseDown.closureListener(this));bkLib.addEvent(this.frameDoc,"keydown",this.keyDown.closureListener(this))},getSel:function(){return bkLib.browser.IE?window.getSelection?window.getSelection():document.selection:this.frameWin?this.frameWin.getSelection():this.frameDoc.selection},
getRng:function(){var a=this.getSel();return!a?null:0<a.rangeCount?a.getRangeAt(0):a.createRange()},selRng:function(a,b){window.getSelection?(b.removeAllRanges(),b.addRange(a)):a.select()},selElm:function(){var a=this.getRng();if(a.startContainer){var b=a.startContainer;if(1==a.cloneContents().childNodes.length)for(var c=0;c<b.childNodes.length;c++){var d=b.childNodes[c].ownerDocument.createRange();d.selectNode(b.childNodes[c]);if(1!=a.compareBoundaryPoints(Range.START_TO_START,d)&&-1!=a.compareBoundaryPoints(Range.END_TO_END,
d))return $BK(b.childNodes[c])}return $BK(b)}return $BK("Control"==this.getSel().type?a.item(0):a.parentElement())},saveRng:function(){this.savedRange=this.getRng();this.savedSel=this.getSel()},restoreRng:function(){this.savedRange&&this.selRng(this.savedRange,this.savedSel)},addNewline:function(a){if(!bkLib.browser.OPERA){if(13!=a.keyCode||a.shiftKey||a.ctrlKey||a.altKey)return!0;bkLib.util.setSelection(this);a=this.keRange.getParentElement().tagName.toLowerCase();bkLib.util.inArray(a,"p h1 h2 h3 h4 h5 h6 pre div li".split(" "))||
this.nicCommand("formatblock","<P>")}},mouseDown:function(){this.ne.fireEvent("close",this)},keyDown:function(a){this.addNewline(a);a.ctrlKey&&this.ne.fireEvent("key",this,a)},focus:function(){this.isFocused=!0;this.frameWin.focus()},blur:function(){this.isFocused=!1},setFilter:function(a){a=a.replace(/\n/g,"");a=a.replace(/<div><\/div>/i,"<br />");return a=a.replace(/<p><\/p>/i,"<br />")},getFilter:function(a){a=a.replace(/^\s*<br[^>]*>\s*$/ig,"");a=a.replace(/^\s*<p>\s*&nbsp;\s*<\/p>\s*$/ig,"");
bkLib.browser.IE||(a=a.replace(/<p><br><\/p>/ig,"<p>&nbsp;</p>"),a=a.replace(/<br><\/p>/ig,"</p>"));return"<p>&nbsp;</p>"==a.toLowerCase()||"<p></p>"==a.toLowerCase()||"<div></div>"==a.toLowerCase()||"<br/>"==a.toLowerCase()||"<br />"==a.toLowerCase()||"<br>"==a.toLowerCase()?"":a},saveContent:function(){if(this.copyElm||this.options.hasPanel){var a=this.getContent();this.copyElm?this.copyElm.value=a:this.e.innerHTML=a}},hasContent:function(a,b){var c=this.frameContent.innerHTML.trim(),c=c.replace(/&nbsp;/ig,
""),c=c.replace(/<BR>/ig,"").replace(/<br>/ig,""),c=c.replace(/<span class="Apple-tab-span" style="white-space:pre">\s*<\/span>/ig,""),c=c.replace(/<P><\/P>/ig,"").replace(/<p><\/p>/ig,""),c=c.replace(/<P>\s*<\/P>/ig,"").replace(/<p>\s*<\/p>/ig,""),c=c.trim().length;return c>a&&c<b},getContent:function(){var a=this.getFilter(this.frameContent.innerHTML);return this.content=a=(new Element("div")).set("html",a).get("html")},setContent:function(a){this.content=this.setFilter(a);this.getElm().innerHTML=
this.content},getElm:function(){return this.frameContent},getWin:function(){return this.frameWin},nicCommand:function(a,b){this.frameDoc.execCommand(a,!1,b)}}),nicEditorPanel=bkClass.extend({construct:function(a,b,c){this.elm=a;this.options=b;this.ne=c;this.panelButtons=[];this.buttonList=bkExtend([],this.ne.options.buttonList);this.panelContain=(new bkElement("DIV")).setstyle({overflow:"hidden",width:"100%",border:"1px solid #cccccc",background:"url("+this.ne.options.bgPath+")"}).addclass("panelContain");
this.panelElm=(new bkElement("DIV")).setstyle({zoom:1,overflow:"hidden",height:"26px"}).addclass("panel").appendTo(this.panelContain);this.panelContain.appendTo(a);b=this.ne.options;c=b.buttons;for(button in c)this.addButton(button,b,!0);this.reorder();a.noSelect()},addButton:function(a,b){var c=b.buttons[a],c=c.type?eval("(typeof("+c.type+') == "undefined") ? null : '+c.type+";"):nicEditorButton,d=bkLib.inArray(this.buttonList,a);if(c&&(d||this.ne.options.fullPanel))this.panelButtons.push(new c(this.panelElm,
a,b,this.ne)),d||this.buttonList.push(a)},findButton:function(a){for(var b=0;b<this.panelButtons.length;b++)if(this.panelButtons[b].name==a)return this.panelButtons[b]},reorder:function(){for(var a=this.buttonList,b=0;b<a.length;b++){var c=this.findButton(a[b]);c&&this.panelElm.appendChild(c.margin)}},remove:function(){this.elm.remove()}}),nicPlugin=bkClass.extend({construct:function(a,b){this.options=b;this.ne=a;this.ne.addEvent("panel",this.loadPanel.closure(this));this.init()},loadPanel:function(a){var b=
this.options.buttons,c;for(c in b)a.addButton(c,this.options);a.reorder()},init:function(){}}),nicPaneOptions={},nicEditorPane=bkClass.extend({construct:function(a,b,c,d){this.ne=b;this.elm=a;this.pos=a.pos();this.contain=(new bkElement("div")).setstyle({zIndex:"99999",overflow:"hidden",position:"absolute",left:this.pos[0]+"px",top:this.pos[1]+"px"});this.pane=(new bkElement("div")).setstyle({fontSize:"12px",border:"1px solid #ccc",overflow:"hidden",padding:"4px",textAlign:"left",backgroundColor:"#ffffc9"}).addclass("pane").setstyle(c).appendTo(this.contain);
d&&!d.options.noClose&&(this.close=(new bkElement("div")).setstyle({"float":"right",height:"16px",width:"16px",cursor:"pointer"}).setstyle(this.ne.getIcon("close",nicPaneOptions)).addevent("mousedown",d.removePane.closure(this)).appendTo(this.pane));this.contain.noSelect().appendTo(document.body);this.position();this.init()},init:function(){},position:function(){if(this.ne.nicPanel){var a=this.ne.nicPanel.elm,a=a.pos()[0]+parseInt(a.getstyle("width"))-(parseInt(this.pane.getstyle("width"))+8);a<this.pos[0]&&
this.contain.setstyle({left:a+"px"})}},toggle:function(){this.isVisible=!this.isVisible;this.contain.setstyle({display:this.isVisible?"block":"none"})},remove:function(){this.contain&&(this.contain.remove(),this.contain=null)},append:function(a){a.appendTo(this.pane)},setContent:function(a){this.pane.setContent(a)}}),nicEditorButton=bkClass.extend({construct:function(a,b,c,d){this.options=c.buttons[b];this.name=b;this.ne=d;this.elm=a;this.margin=(new bkElement("DIV")).setstyle({"float":"left"}).appendTo(a);
this.contain=(new bkElement("DIV")).setstyle({height:"26px","float":"left"}).addclass("buttonContain").appendTo(this.margin);this.button=(new bkElement("DIV")).setstyle({border:"1px solid #d7d7d7",padding:"4px",width:"12px",height:"16px",overflow:"hidden",zoom:1,cursor:"pointer"}).addclass("button").setstyle(this.ne.getIcon(b,c)).appendTo(this.contain);window.opera||(this.button.onmousedown=this.button.onclick=bkLib.cancelEvent);d.addEvent("selected",this.enable.closure(this)).addEvent("key",this.key.closure(this));
this.disable();this.init()},init:function(){this.button.addevent("mouseover",this.hoverOn.closure(this)).addevent("mouseout",this.hoverOff.closure(this)).addevent("mousedown",this.mouseClick.closure(this)).noSelect()},hide:function(){this.contain.setstyle({display:"none"})},updateState:function(){this.isDisabled?this.setBg():this.isHover?this.setBg("hover"):this.isActive?this.setBg("active"):this.setBg()},setBg:function(a){switch(a){case "hover":var b={borderTop:"1px solid #999",borderRight:"1px solid #fff",
borderBottom:"1px solid #fff",borderLeft:"1px solid #999",margin:"0"};break;case "active":b={borderTop:"1px solid #999",borderRight:"1px solid #fff",borderBottom:"1px solid #fff",borderLeft:"1px solid #999",margin:"0"};break;default:b={borderTop:"1px solid #f0f0f0",borderBottom:"1px solid #d2d2d2",borderRight:0,borderLeft:0,margin:"0 1px"}}this.button.className="";this.button.setstyle(b).addclass("button-"+(a||"def"))},enable:function(){this.isDisabled=!1;this.contain.setstyle({opacity:1}).addclass("buttonEnabled");
this.updateState()},disable:function(){this.isDisabled=!0;this.contain.setstyle({opacity:0.5}).removeclass("buttonEnabled");this.updateState()},hoverOn:function(){this.isDisabled||(this.isHover=!0,this.updateState())},hoverOff:function(){this.isHover=!1;this.updateState()},mouseClick:function(){this.options.command&&this.ne.nicCommand(this.options.command,this.options.commandArgs)},key:function(a,b){if(this.options.key&&b.ctrlKey&&String.fromCharCode(b.keyCode||b.charCode).toLowerCase()==this.options.key)this.mouseClick(),
b.preventDefault&&b.preventDefault()}}),nicEditorSelect=nicEditorButton.extend({init:function(){this.selOptions=[];this.ne.addEvent("close",this.close.closure(this));this.button.addevent("mouseover",this.hoverOn.closure(this)).addevent("mouseout",this.hoverOff.closure(this)).addevent("click",this.toggle.closure(this)).noSelect();this.or()},or:function(){},disable:function(){this.isDisabled=!0;this.contain.setstyle({opacity:0.5}).removeclass("buttonEnabled");this.updateState();this.close()},enable:function(){this.isDisabled=
!1;this.contain.setstyle({opacity:1}).addclass("buttonEnabled");this.updateState();this.close()},toggle:function(){this.isDisabled||(this.pane?this.close():this.open())},open:function(){this.pane=new nicEditorPane(this.contain,this.ne,{width:"88px",height:"132px",overflowY:"auto",padding:"0",borderTop:0,backgroundColor:"#fff"});for(var a=0;a<this.selOptions.length;a++){var b=this.selOptions[a],c=(new bkElement("div")).setstyle({width:"88px",textAlign:"left",overflow:"hidden",cursor:"pointer"}),d=
(new bkElement("div")).setstyle({padding:"0px 4px"}).setContent(b[1]).appendTo(c).noSelect();d.addevent("click",this.update.closure(this,b[0])).addevent("mouseover",this.over.closure(this,d)).addevent("mouseout",this.out.closure(this,d)).setattributes("id",b[0]);this.pane.append(c);window.opera||(d.onmousedown=bkLib.cancelEvent)}},close:function(){this.pane&&(this.pane=this.pane.remove())},over:function(a){a.setstyle({backgroundColor:"#ccc"})},out:function(a){a.setstyle({backgroundColor:"#fff"})},
add:function(a,b){this.selOptions&&this.selOptions.push([a,b])},update:function(a){this.ne.nicCommand(this.options.command,a);this.close()}}),nicSelectOptions={buttons:{fontSize:{name:"Select Font Size",type:"nicEditorFontSizeSelect",command:"fontsize"},forecolor:{name:"Select Fore Color",type:"nicEditorColorSelect",command:"forecolor"},fontFamily:{name:"Select Font Family",type:"nicEditorFontFamilySelect",command:"fontfamily"}}},nicEditorFontSizeSelect=nicEditorSelect.extend({sel:{12:"小号",14:"正常",
16:"中号",20:"大号",24:"超大"},or:function(){this.button.setstyle({width:"18px"});for(itm in this.sel)this.add(itm,'<span style="font-size:'+itm+'px;">'+this.sel[itm]+"</span>")},update:function(a){this.ne.selectedInstance.focus();bkLib.util.setSelection(this.ne.selectedInstance);(new bkLib.cmd(this.ne.selectedInstance)).wrap("span",[{".font-size":a+"px"}]);this.close()}}),nicEditorFontFamilySelect=nicEditorSelect.extend({sel:{SimSun:"宋体",NSimSun:"新宋体",arial:"Arial",verdana:"Verdana",tahoma:"Tahoma"},or:function(){this.button.setstyle({width:"18px"});
for(itm in this.sel)this.add(itm,'<span style="font-family:'+itm+'">'+this.sel[itm]+"</span>")},open:function(){this.ne.selectedInstance.focus();this.pane=new nicEditorPane(this.contain,this.ne,{width:"88px",height:"95px",overflowY:"auto",padding:"0",borderTop:0,backgroundColor:"#fff"});for(var a=0;a<this.selOptions.length;a++){var b=this.selOptions[a],c=(new bkElement("div")).setstyle({width:"88px",textAlign:"left",overflow:"hidden",cursor:"pointer"}),d=(new bkElement("div")).setstyle({padding:"0px 4px"}).setContent(b[1]).appendTo(c).noSelect();
d.addevent("click",this.update.closure(this,b[0])).addevent("mouseover",this.over.closure(this,d)).addevent("mouseout",this.out.closure(this,d)).setattributes("id",b[0]);this.pane.append(c);window.opera||(d.onmousedown=bkLib.cancelEvent)}},update:function(a){bkLib.util.setSelection(this.ne.selectedInstance);(new bkLib.cmd(this.ne.selectedInstance)).wrap("span",[{".font-family":a}]);this.close()}}),nicEditorColorSelect=nicEditorSelect.extend({sel:{1:"000000",2:"FF0000",3:"FFFF00",4:"308014",5:"0000FF",
6:"660099",7:"C0C0C0",8:"FFCCCC",9:"FAFAB4",10:"99FF99",11:"99CCFF",12:"CC99CC",13:"808A87",14:"F08080",15:"FF9900",16:"31CD32",17:"00CCFF",18:"DA70D6",19:"708069",20:"FF69B4",21:"FF6103",22:"66CDAA",23:"336699",24:"6666CC",25:"808069",26:"FF0066",27:"8B4513",28:"009999",29:"082E54",30:"9933CC",31:"292421",32:"990000",33:"5E2612",34:"556B2F",35:"191970",36:"990066"},or:function(){for(itm in this.sel)this.add("#"+this.sel[itm],this.sel[itm])},open:function(){this.ne.selectedInstance.focus();this.pane=
new nicEditorPane(this.contain,this.ne,{width:"183px",height:"138px",overflowY:"auto",padding:"0",border:"1px solid #ccc",borderTop:0,backgroundColor:"#fff"});for(var a=(new bkElement("ul")).setstyle({width:"183px",padding:"5px 2px 2px 2px",textAlign:"left",overflow:"hidden"}).noSelect(),b=0;b<this.selOptions.length;b++){var c=this.selOptions[b],d=(new bkElement("li")).setstyle({cursor:"pointer",overflow:"hidden","float":"left",width:"20px",height:"20px",margin:"0 5px 0 5px",background:"#"+c[1]}).appendTo(a).noSelect();
6>b&&d.setstyle({margin:"0 5px 10px 5px"});d.addevent("click",this.update.closure(this,c[0]));window.opera||(d.onmousedown=bkLib.cancelEvent)}this.pane.append(a)},update:function(a){bkLib.util.setSelection(this.ne.selectedInstance);(new bkLib.cmd(this.ne.selectedInstance)).wrap("span",[{".color":a}]);this.close()}});nicEditors.registerPlugin(nicPlugin,nicSelectOptions);
var nicInsertOptions={buttons:{insert:{name:"insert",type:"nicEditorInsert"}}},nicEditorInsert=nicEditorSelect.extend({sel:{link:"插入链接",img:"插入图片",video:"插入视频"},or:function(){this.button.setstyle({width:"55px"});for(itm in this.sel)this.add(itm,"<div>"+this.sel[itm]+"</div>")},open:function(){this.pane=new nicEditorPane(this.contain,this.ne,{width:"70px",height:"70px",overflowY:"auto",padding:"0",borderTop:0,backgroundColor:"#fff"});for(var a=0;a<this.selOptions.length;a++){var b=this.selOptions[a],
c=(new bkElement("div")).setstyle({width:"70px",lineHeight:"20px",textAlign:"center",overflow:"hidden",cursor:"pointer"}),d=(new bkElement("div")).setstyle({padding:"0px 4px"}).setContent(b[1]).appendTo(c).noSelect();d.addevent("mouseover",this.over.closure(this,d)).addevent("mouseout",this.out.closure(this,d)).setattributes("id",b[0]);switch(b[0]){case "link":d.addevent("click",this.linkMouseClick.closure(this));break;case "img":d.addevent("click",this.imgMouseClick.closure(this));break;case "video":d.addevent("click",
this.videoMouseClick.closure(this));break;case "table":d.addevent("click",this.tableMouseClick.closure(this))}this.pane.append(c);window.opera||(d.onmousedown=bkLib.cancelEvent)}},findElm:function(a,b,c){for(var a=this.ne.selectedInstance.getElm().getElementsByTagName(a),d=0;d<a.length;d++)if(a[d].getAttribute(b)==c)return a[d]},linkMouseClick:function(){if(!this.isDisabled){try{this.ne.selectedInstance.focus(),this.ne.selectedInstance.frameDoc.body.focus()}catch(a){}this.close();this.ne.selectedInstance&&
this.ne.selectedInstance.saveRng();var b=prompt("输入链接地址\n（如：http://www.dianping.com）:","http://");b&&"http://"!=b&&this.linkSubmit(b)}},linkSubmit:function(a){var b=this.ne.selectedInstance;bkLib.util.setSelection(b);for(var c=b.keRange,d=c.startNode,e=c.endNode,h=b.frameDoc,f=c.getParentElement();f&&!("a"==f.tagName.toLowerCase()||"body"==f.tagName.toLowerCase());)f=f.parentNode;var f=f.parentNode,e=bkLib.browser.IE?!!b.range.item:1==d.nodeType&&d===e&&"br"!=d.nodeName.toLowerCase(),g=!e;e||(g=bkLib.browser.IE?
""===b.range.text:""===b.range.toString());if(g)bkLib.util.insertHtml(b,'<a href="'+a+'" target="_blank"'+(">"+a+"</a>"));else{h.execCommand("createlink",!1,"__ke_temp_url__");for(var f=f.getElementsByTagName("a"),g=0,i=f.length;g<i;g++)f[g].href.match(/\/?__ke_temp_url__$/)&&(f[g].href=a,f[g].target="_blank");bkLib.browser.WEBKIT&&(e&&"img"==d.tagName.toLowerCase())&&(e=d.parentNode,"a"!=e.tagName.toLowerCase()&&(h=bkLib.util.$$("a",h),e.insertBefore(h,d),h.appendChild(d),e=h),e.href=a,e.target=
"_blank",b.keSel.addRange(c))}},imgMouseClick:function(){if(!this.isDisabled){try{this.ne.selectedInstance.focus(),this.ne.selectedInstance.frameDoc.body.focus()}catch(a){}this.close();this.ne.selectedInstance&&(this.im=null);var b=prompt("输入图片地址\n（如：http://www.dianping.com/Comm/Images/Logo.gif）:","http://");b&&"http://"!=b&&this.imgSubmit(b)}},imgSubmit:function(a){this.im||(this.ne.nicCommand("insertImage","javascript:dpimg"),this.im=this.findElm("IMG","src","javascript:dpimg"));this.im&&(this.im.src=
a)},checkDPEditorVideoCode:function(a){var b=RegExp("<embed[^>]*>(.*?)</embed>","gi"),c=RegExp("<object[^>]*>(.*?)</object>","gi").exec(a);return null==c&&(c=b.exec(a),null==c)?(a=RegExp("http://(www.|player.)?(6.cn|youku.com|youtube.com|tudou.com|56.com|ku6.com)/[^.!,?;\"']+(?:[.!,?]+[^.!,?;\"']+)*","gi").exec(a),null==a?null:a[0]):0==c.index?(a=RegExp('<embed [^>]*src="(http://(www.|player.)?(6.cn|youku.com|youtube.com|tudou.com|56.com|ku6.com)/[^"]*)"[^>]*>',"gi").exec(a),null==a?null:a[1]):null},
videoMouseClick:function(){if(!this.isDisabled){this.close();var a=prompt("部落目前支持优酷、土豆、六间房、56、Ku6、Youtube多家视频网站。\n请输入上述视频网站提供的分享html代码或flash地址\n","");a&&((a=this.checkDPEditorVideoCode(a))?this.videoSubmit(a):alert("部落目前仅支持优酷、土豆、六间房、56、Ku6、Youtube这几家视频网站\n请输入正确的分享html代码或flash地址"))}},videoSubmit:function(a){var b=this.ne.selectedInstance.getWin().document.createElement("P");b.innerHTML="[video]"+a+"[/video]";this.ne.selectedInstance.getElm().appendChild(b)},tableMouseClick:function(){if(!this.isDisabled){this.close();
var a=[],b=this;a.push('<div class="DialogTitle">插入表格</div>');a.push('<div class="DialogContent">');a.push('<ul id="editor_table" style="line-height:35px;">');a.push("<li>");a.push('<label for="editor_rows">单元格数</label>');a.push('行数&nbsp;<input type="text" value="3" style="vertical-align:middle;width:50px;margin-right:10px" maxlength="4" value="" name="editor_rows" id="editor_rows">');a.push('列数&nbsp;<input type="text" value="2" style="vertical-align:middle;width:50px" maxlength="4" value="" name="editor_cols" id="editor_cols">');
a.push("</li><li>");a.push('<label for="editor_width">表格大小</label>');a.push('宽度&nbsp;<input align="absmiddle" type="text" value="100" style="vertical-align:middle;width:50px" maxlength="4" value="" name="editor_width" id="editor_width">');a.push('<select align="absmiddle" style="margin-right:10px" name="editor_widthType" id="editor_widthType"><option value="%">%</option><option value="px">px</option></select>');a.push('高度&nbsp;<input align="absmiddle" type="text" style="vertical-align:middle;width:50px" maxlength="4" value="" name="editor_height" id="editor_height">');
a.push('<select align="absmiddle" style="margin-right:10px" name="editor_heightType" id="editor_heightType"><option value="%">%</option><option value="px">px</option></select>');a.push("</li><li>");a.push('<label for="editor_padding">边距间距</label>');a.push('边距&nbsp;<input type="text" value="2" style="vertical-align:middle;width:50px;margin-right:10px" maxlength="4" value="" name="editor_padding" id="editor_padding">');a.push('间距&nbsp;<input type="text" value="0" style="vertical-align:middle;width:50px" maxlength="4" value="" name="editor_spacing" id="editor_spacing">');
a.push("</li><li>");a.push('<label for="editor_align">对齐方式</label>');a.push('<select name="editor_align" id="editor_align"><option value="">默认</option><option value="left">左对齐</option><option value="center">居中</option><option value="right">右对齐</option></select>');a.push("</li><li>");a.push('<label for="editor_border">表格边框</label>');a.push('边框&nbsp;<input type="text" value="1" style="vertical-align:middle;width:50px;margin-right:10px" maxlength="4" value="" name="editor_border" id="editor_border">');
a.push("</li></ul>");a.push("</div>");a.push('<div class="DialogButtons"><button type="button" id="editor_sub">确定</button><button type="button" id="editor_cas">取消</button></div>');Mbox.open({url:a.join(""),type:"string",size:{x:380,y:270},onShow:function(){$BK("editor_sub").addevent("click",b.tableSubmit.closure(b));$BK("editor_cas").addevent("click",function(){Mbox.close()})}})}},tableSubmit:function(){var a=$BK("editor_rows"),b=$BK("editor_cols"),c=$BK("editor_width"),d=$BK("editor_height"),e=$BK("editor_widthType"),
h=$BK("editor_heightType"),f=$BK("editor_padding"),g=$BK("editor_spacing"),i=$BK("editor_align"),l=$BK("editor_border"),n=a.value,m=b.value,k=c.value,q=d.value,e=e.value,t=h.value,h=f.value,p=g.value,i=i.value,j=l.value;if(""==n||0==n||!n.match(/^\d*$/))return alert("请输入正确的行数"),a.focus(),!1;if(""==m||0==m||!m.match(/^\d*$/))return alert("请输入正确的列数"),b.focus(),!1;if(!k.match(/^\d*$/))return alert("请输入正确的宽度"),c.focus(),!1;if(!q.match(/^\d*$/))return alert("请输入正确的高度"),d.focus(),!1;if(!h.match(/^\d*$/))return alert("请输入正确的格式"),
f.focus(),!1;if(!p.match(/^\d*$/))return alert("请输入正确的格式"),g.focus(),!1;if(!j.match(/^\d*$/))return alert("请输入正确的边框"),l.focus(),!1;a="";""!==k&&(a+="width:"+k+e+";");""!==q&&(a+="height:"+q+t+";");k="<table";""!==a&&(k+=' style="'+a+'"');""!==h&&(k+=' cellpadding="'+h+'"');""!==p&&(k+=' cellspacing="'+p+'"');""!==i&&(k+=' align="'+i+'"');if(""===j||"0"===j)k+=' class="zeroborder"';""!==j&&(k+=' border="'+j+'"');k+=">";for(q=0;q<n;q++){k+="<tr>";for(a=0;a<m;a++)k+="<td>&nbsp;</td>";k+="</tr>"}k+="</table>";
bkLib.util.setSelection(this.ne.selectedInstance);bkLib.util.insertHtml(this.ne.selectedInstance,k);Mbox.close()}});nicEditors.registerPlugin(nicPlugin,nicInsertOptions);var nicUploadOptions={buttons:{upload:{name:"upload",type:"nicEditorUpload"}}};function editorClose(){window.SnicEditor&&(window.SnicEditor=null);Mbox.hide()}function editorUploadSuccess(){}function editorGetParam(){var a=document.getElementById("ut");return a?(a=a.value,"Referrer="+window.location.href+"&amp;ut="+a):!1}
var nicEditorUpload=nicEditorButton.extend({init:function(){this.button.setstyle({width:"65px"});this.button.addevent("mouseover",this.hoverOn.closure(this)).addevent("mouseout",this.hoverOff.closure(this)).addevent("mousedown",this.open.closure(this)).noSelect()},open:function(){var a=DP.mbox;a.close();if(!this.isDisabled){try{this.ne.selectedInstance.focus(),this.ne.selectedInstance.frameDoc.body.focus()}catch(b){}editorGetParam()?(window.SnicEditor=this.ne,a.open({winCls:"pop-win pop-box pop-upload-pic J_popUploadPic",
closable:!0,size:{x:632,y:480},url:a.dialog("上传图片",'<div id="J_container" class="con"><div class="J_tipsBox tips"><div class="J_tips tips-text">您可以选择一张或多张图片进行上传，每次最多选择上传20张。</div></div><div class="J_startBox no-pic"><div class="box-btnUp" title="上传图片"><span class="btn-upload" id="J_btnUpload">上传图片</span></div></div><div class="J_listBox upload-box Hide"><div class="upload-pic-list"><ul class="J_ul"><li class="J_li Hide"><div class="J_image pic"><img class="J_pic" width="120" height="90"/><a class="J_cancel p-del Hide" href="javascript:void(0);" title="取消"><i class="icon-del"></i></a><div class="J_progress progress-box Hide"><span class="progre"><i class="J_bar progre-cur"></i></span></div></div><div class="J_state txt"><span><i class="icon-loading"></i>正在上传</span></div></li></ul></div></div><div class="J_statusBox upload-pic-status Hide"><div class="J_totalProgress progress-box"><span class="progre"><i class="J_percent progre-cur" style="width:1%"></i></span><span class="J_num progre-tips">0/0</span></div><div class="J_btns btn-box Hide"><span class="big-btn btn"><a class="J_finish btn-txt" title="完成上传" href="javascript:void(0);">完成上传</a></span><span class="big-btn-ash"><a class="J_quit btn-txt" title="取消" href="javascript:void(0);">取消</a></span></div></div></div>'),
onShow:function(){var c,b=new DP._Handlers({fileUploadLimit:20}),e=DP.data("picUpload");c=new SWFUpload({upload_url:e.picUploadUrl,file_post_name:"Filedata",post_params:{sign:e.picSignature,nut:e.picToken},file_size_limit:"5 MB",file_types:"*.jpg;*.jpeg;*.gif;*.png;*.bmp",file_types_description:"Images Files",file_upload_limit:20,file_queue_limit:20,customSettings:{progressTarget:"fsUploadProgress",cancelButtonId:"btnCancel"},flash_url:e.picUploadFlashUrl,button_window_mode:SWFUpload.WINDOW_MODE.TRANSPARENT,
button_cursor:SWFUpload.CURSOR.HAND,button_image_url:e.picUploadButtonImageUrl,button_placeholder_id:"J_btnUpload",button_width:151,button_height:49,minimum_flash_version:"9.0.28",debug:!1,swfupload_pre_load_handler:b.swfUploadPreLoad,swfupload_load_failed_handler:b.swfUploadLoadFailed,swfupload_loaded_handler:b.swfUploadLoaded,file_queued_handler:b.fileQueued,file_queue_error_handler:b.fileQueueError,file_dialog_complete_handler:b.fileDialogComplete,upload_start_handler:b.uploadStart,upload_progress_handler:b.uploadProgress,
upload_error_handler:b.uploadError,upload_success_handler:b.uploadSuccess,upload_complete_handler:b.uploadComplete,queue_complete_handler:b.queueComplete});DP.SWFU=c;$$(".J_popUploadPic")[0].getElement(".close").removeEvents("click").addEvent("click",function(b){b.stop();c&&c.destroy();a.close()})}}),bkLib.util.setSelection(this.ne.selectedInstance)):alert("上传组件加载失败!")}}});nicEditors.registerPlugin(nicPlugin,nicUploadOptions);
var nicZoomOptions={buttons:{large:{name:"增大编辑区域",type:"nicEditorLargeSelect"},small:{name:"缩小编辑区域",type:"nicEditorSmallSelect"}}},nicEditorZoom=nicEditorButton.extend({construct:function(a,b,c,d){this.options=c.buttons[b];this.elm=a;this.ne=d;this.name=b;this.selOptions=[];this.margin=(new bkElement("DIV")).setstyle({"float":"right"}).appendTo(a);this.contain=(new bkElement("DIV")).setstyle({width:"20px",height:"26px"}).addclass("buttonContain").appendTo(this.margin);this.button=(new bkElement("A")).setstyle({border:"1px solid #d7d7d7",
padding:"4px",width:"12px",height:"16px",overflow:"hidden",zoom:1,display:"block",cursor:"pointer"}).addclass("button").setstyle(this.ne.getIcon(b,c)).setattributes({title:c.buttons[b].name}).appendTo(this.contain);this.button.addevent("mouseover",this.hoverOn.closure(this)).addevent("mouseout",this.hoverOff.closure(this)).addevent("mousedown",this.mouseClick.closure(this)).noSelect();window.opera||(this.button.onmousedown=this.button.onclick=bkLib.cancelEvent);this.margin.noSelect();this.ne.addEvent("selected",
this.enable.closure(this));this.disable();this.init()}}),nicEditorLargeSelect=nicEditorZoom.extend({mouseClick:function(){if(!this.isDisabled){var a;a=this.ne.selectedInstance.elmFrame;a.setstyle({height:a.offsetHeight+200+"px"})}}}),nicEditorSmallSelect=nicEditorZoom.extend({mouseClick:function(){if(!this.isDisabled){var a,b,c=this.ne.selectedInstance.initialHeight;a=this.ne.selectedInstance.elmFrame;b=a.offsetHeight;a.setstyle({height:b-200<=c?c+"px":b-200+"px"})}}});
nicEditors.registerPlugin(nicPlugin,nicZoomOptions);
var nicEditorEmotion=bkClass.extend({construct:function(a,b){this.ne=a;this.imgPathArray=b.imgPathArray;this.exec=[];this.ne.addEvent("emotion",this.build.closure(this))},build:function(a){this.textarea=a;this.contain=(new bkElement("div")).setstyle({width:"664px",height:"30px",overflow:"hidden",position:"relative"}).addclass("emotionContain").appendBefore(this.textarea);this.items=(new bkElement("div")).setstyle({overflow:"hidden",width:"580px"}).appendTo(this.contain);this.control=(new bkElement("div")).setstyle({position:"absolute",
height:"20px",width:"20px",right:"0",top:"2px",cursor:"pointer"}).setstyle(this.ne.getIcon("emo1")).appendTo(this.contain).addevent("click",this.toggle.closure(this));window.opera||(this.contain.onmousedown=this.control.onmousedown=this.items.onmousedown=bkLib.cancelEvent);this.contain.noSelect();this.ne.addEvent("selected",this.enable.closure(this));this.disable();this.init()},init:function(){this.hide()},enable:function(){this.isDisabled=!1},disable:function(){this.isDisabled=!0},toggle:function(){this.status&&
"show"==this.status?this.hide():this.show()},padding:["2px","4px","7px","0"],show:function(){if(2>this.exec.length){this.exec.push(2);this.items.innerHTML="";for(var a=1;90>=a;a++)50<a?this.items.appendChild((new bkElement("IMG")).setstyle({padding:this.padding.join(" "),cursor:"pointer",width:"50px",height:"50px"}).addclass("emotion").setattributes({src:this.imgPath("Emoticon"+a+".gif",a),width:"50",height:"50"}).addevent("click",this.mouseClick.closureListener(this))):this.items.appendChild((new bkElement("IMG")).setstyle({padding:this.padding.join(" "),
cursor:"pointer",width:"19px",height:"19px"}).addclass("emotion").setattributes({src:this.imgPath("Emoticon"+a+".gif",a),width:"19",height:"19"}).addevent("click",this.mouseClick.closureListener(this)))}this.control.setstyle(this.ne.getIcon("emo2"));this.status="show";this.contain.setstyle({height:"auto"})},hide:function(){if(1>this.exec.length){this.exec.push(1);for(var a=1;25>=a;a++)this.items.appendChild((new bkElement("IMG")).setstyle({padding:this.padding.join(" "),cursor:"pointer",width:"19px",
height:"19px"}).addclass("emotion").setattributes({src:this.imgPath("Emoticon"+a+".gif",a),width:"19",height:"19"}).addevent("click",this.mouseClick.closureListener(this)))}this.control.setstyle(this.ne.getIcon("emo1"));this.status="hide";this.contain.setstyle({height:"30px"})},findElm:function(a,b,c){for(var a=this.ne.selectedInstance.getElm().getElementsByTagName(a),d=0;d<a.length;d++)if(a[d].getAttribute(b)==c)return $BK(a[d])},mouseClick:function(a,b){this.isDisabled||(this.ne.selectedInstance&&
(this.ne.selectedInstance.focus(),this.ne.selectedInstance.saveRng()),this.submit(b))},submit:function(a){var b=a.src,c=Number(a.width),a=Number(a.height);bkLib.browser.IE&&8>bkLib.browser.VERSION&&(c-=parseInt(this.padding[1])+parseInt(this.padding[3]),a-=parseInt(this.padding[0])+parseInt(this.padding[2]));if(bkLib.browser.IE)this.ne.selectedInstance.savedRange&&"Control"!=this.ne.selectedInstance.savedSel.type&&(this.ne.selectedInstance.savedRange.pasteHTML('<img src="'+b+'" width="'+c+'" height="'+
a+'"/>'),this.ne.selectedInstance.savedRange.select()),this.ne.selectedInstance.savedRange=null;else{this.ne.nicCommand("insertImage",b);for(var b=this.ne.selectedInstance.frameDoc.body.getElementsByTagName("img"),d=[],e=0;e<b.length;e++)b[e].getAttribute("src").test(/Emoticon\d+\.gif/)&&!b[e].getAttribute("width")&&d.push(b[e]);b=d[d.length-1];b.width=c;b.height=a}},imgPath:function(a,b){return"http://i"+this.imgPathArray[b%this.imgPathArray.length]+".dpfile.com/s/img/editor/"+a}});
nicEditors.registerPlugin(nicEditorEmotion,{imgPathArray:[1,2,3]});
