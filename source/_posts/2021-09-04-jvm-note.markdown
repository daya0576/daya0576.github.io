---
title: Java å†…å­˜ç®¡ç† - SRE çš„å¿…ä¿®è¯¾
date: 2021-09-04 16:31:21
tags: java
---

åœ¨è¿‡å»ä¸‰å¹´ SRE çš„ç»å†ä¸­ï¼Œé‡åˆ°è¿‡å¤šèµ·å› ä¸º JVM OOM å¯¼è‡´çš„çº¿ä¸Šæ•…éšœã€‚å…¶ä¸­å°è±¡æœ€æ·±çš„ä¸€æ¬¡æ’æŸ¥ç»å†ï¼šæ”¶åˆ°æ•…éšœå¤–å‘¼åï¼Œå‡ ä¸ªå¤§ç”·äººç°åœºæ¢³ç†ä¸šåŠ¡é“¾è·¯ï¼Œå¤§çœ¼çªå°çœ¼ï¼Œæœ€åå‘ç°æ ¹å› ç«Ÿç„¶æ˜¯éƒ¨åˆ†ç½‘å…³æœºå™¨åŠ¨æ€åŠ è½½æ•°æ®åº“ä¸­çš„ groovy è„šæœ¬ï¼Œå¯¼è‡´ `Metaspace out of memory` æŠ¥é”™ï¼Œå½±å“äº†éƒ¨åˆ† XX å•†æˆ·çš„ä»£æ‰£ä¸šåŠ¡ï¼Œæœ€ç»ˆè½äº†ä¸€ä¸ª P4 æ•…éšœ Tâ€¦T

ä½†æ˜¯ä¹‹åå¾ˆé•¿ä¸€æ®µæ—¶é—´å†…ï¼Œéƒ½ä¸å¤ªæ˜ç™½ Metaspace æ˜¯ä»€ä¹ˆï¼Œä¸ºä»€ä¹ˆä¼šè€—å°½ï¼Ÿå’Œ perm åŒºçš„å…³ç³»æ˜¯ï¼Ÿä¸åŒçº¿ç¨‹æœ¬åœ°å˜é‡å’Œå…¨å±€å¯¹è±¡çš„å…³ç³»ï¼Ÿ

æ­£å¥½è¶è¿™æ¬¡æœºä¼šï¼Œç³»ç»Ÿæ€§çš„æ•´ç†å’Œåˆ†äº«ä¸€ä¸‹ ï¼šï¼‰

<!--more-->

## ä¸€ã€èµ°è¿‘ Java

é¦–å…ˆé¢„çƒ­ä¸€ä¸‹ï¼Œç®€å•è§£é‡Šå‡ ä¸ªå¸¸è§åè¯ï¼š`JVM` -> `JRE` -> `JDK` 

- `JVMï¼ˆJava Virtual Machineï¼‰`ï¼šJavaè™šæ‹Ÿæœºï¼Œå®ƒå®ç°äº†ä¸€æ¬¡ç¼–è¯‘åˆ°å¤„è¿è¡Œï¼Œä¾‹å¦‚ HotSpot ç­‰
- `JREï¼ˆJava Runtime Environmentï¼‰`ï¼ŒJREæ˜¯æ”¯æŒJavaç¨‹åºè¿è¡Œçš„æ ‡å‡†ç¯å¢ƒã€‚åŒ…å« Java SE API å­é›† / è™šæ‹Ÿæœº 
- `JDKï¼ˆJava Development Kitï¼‰`ï¼šJavaç¨‹åºå¼€å‘çš„æœ€å°ç¯å¢ƒã€‚åŒ…å« ç¨‹åºè¯­è¨€ / è™šæ‹Ÿæœº / åŸºç¡€ç±»åº“ç­‰ï¼Œä¾‹å¦‚ OpenJDK ç­‰ 

ä¹¦ä¸­æœ‰ä¸€æ®µæ€»ç»“æŒºæœ‰æ„æ€çš„ï¼Œåˆ†äº«ä¸€ä¸‹ï¼š*â€œOracleæ”¶è´­Sunæ˜¯Javaå‘å±•å†å²ä¸Šä¸€é“æ˜æ˜¾çš„åˆ†ç•Œçº¿ã€‚åœ¨SunæŒèˆµçš„å‰åå‡ å¹´é‡Œï¼ŒJavaè·å¾—å·¨å¤§æˆåŠŸï¼ŒåŒæ—¶ä¹Ÿæ¸æ¸æ˜¾éœ²å‡ºæ¥è¯­è¨€æ¼”è¿›çš„ç¼“æ…¢ä¸ç¤¾åŒºå†³ç­–çš„è€æœ½ï¼›è€Œåœ¨Oracleä¸»å¯¼Javaåï¼Œå¼•èµ·ç«äº‰çš„åŒæ—¶ä¹Ÿå¸¦æ¥æ–°çš„æ´»åŠ›ï¼ŒJavaå‘å±•çš„é€Ÿåº¦è¦æ˜¾è‘—é«˜äºSunæ—¶ä»£ã€‚Javaçš„æœªæ¥æ˜¯ç»§ç»­å‘å‰ã€å†æ”€é«˜å³°ï¼Œè¿˜æ˜¯ç”±ç››è½¬è¡°ã€é”‹èŠ’æŒ«ç¼©ï¼Œä½ æˆ‘æ‹­ç›®ä»¥å¾…â€*


## äºŒã€è‡ªåŠ¨å†…å­˜ç®¡ç†
è¿›å…¥æ­£æ–‡ï¼ğŸ‰ğŸ‰ğŸ‰ 

### Java å†…å­˜åŒºåŸŸ
ç½‘ä¸Šå¾ˆå¤šæ–‡ç« å› ä¸º java ç‰ˆæœ¬çš„é—®é¢˜ï¼Œå­˜åœ¨ä¸åŒç¨‹åº¦çš„è¿‡æ—¶ã€‚

æ‰€ä»¥èŠ±äº†ä¸€ç‚¹æ—¶é—´ï¼Œå°è¯•é€šè¿‡ã€Œæ ˆã€å’Œã€Œå †ã€ä¸¤ä¸ªè§†è§’ï¼Œå°† java8 çš„å†…å­˜åˆ†å¸ƒé‡æ–°ç»˜åˆ¶ä¸€éåŠ æ·±ç†è§£ï¼š
![](../images/blog/2021-09-04-jvm-note/16307787626886.jpg)
ï¼ˆp.s. å¦‚æœæœ‰ä¸å¯¹çš„åœ°æ–¹è¾›è‹¦å¸®å¿™æŒ‡æ­£ï¼‰

 
### å…³é”®ç‚¹è¯´æ˜
#### 1. å…³äº Perm åŒº & Metaspace
ä¸ºäº†è§£å†³ æŒä¹…ä»£å†…å­˜æº¢å‡º & ä¸åŒè™šæ‹Ÿæœºèåˆç­‰ç›®çš„ï¼ŒæŒä¹…ä»£ï¼ˆPermGenï¼‰åœ¨ 1.8 ä»¥åè¢« Metaspace å–ä»£ã€‚

æˆ‘ä¸ªäººç†è§£æœ€å¤§ä¸åŒåœ¨äºï¼š1.8 ä¹‹å‰ï¼ŒæŒä¹…ä»£ä¸ Heap & Stack éƒ½å½’å±**è™šæ‹Ÿæœºå†…å­˜**ï¼Œè€Œ Metaspace ä¾§ä½¿ç”¨çš„**æœ¬åœ°å†…å­˜**ï¼ˆnative memoryï¼‰ï¼Œ**é»˜è®¤ä¸åšé™åˆ¶**ã€‚

**æ—¢ç„¶æ²¡æœ‰é™åˆ¶ï¼Œæ–‡ç« å¼€å¤´æ•…éšœä¸ºä»€ä¹ˆè¿˜ä¼šå‘ç”Ÿå‘¢ï¼Ÿï¼Ÿ**   
å› ä¸ºé€šå¸¸è¿˜æ˜¯ä¹ æƒ¯è®¾ç½® `-XX:MaxMetaspaceSize` å‚æ•°ã€‚ã€‚æ‰€ä»¥å¦‚æœä»£ç ç¼–å†™ä¸å½“ï¼Œç±»å æ®çš„ç©ºé—´è¿˜æ˜¯å¾ˆå¯èƒ½è¶…è¿‡æŒ‡å®šçš„ç©ºé—´å¤§å°ï¼Œé€ æˆ`java.lang.OutOfMemoryError: Metaspace` å¼‚å¸¸ :(

#### 2. å…³äºæ ˆå¸§ï¼ˆStack Frameï¼‰
ç¨‹åºè¿è¡Œæœ¬è´¨ä¸Šæ˜¯æ–¹æ³•çš„å¥—å¨ƒè°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯ä¸æ–­å…¥æ ˆä¸å‡ºæ ˆçš„è¿‡ç¨‹ã€‚

è€Œæ¯ä¸ªæ ˆå¸§ï¼ˆStack Frameï¼‰ä¸­ï¼Œæœ¬åœ°å˜é‡ï¼ˆLocal Variablesï¼‰ä¸ Heap çš„å…³ç³»å¦‚ä¸‹ï¼š
![](../images/blog/2021-09-04-jvm-note/16307786911033.jpg)

#### 3. å…³äºè¿è¡Œæ—¶å¸¸é‡æ± ï¼ˆRun-Time Constant Poolï¼‰
##### 1ï¼‰é¦–å…ˆç†è§£ class æ–‡ä»¶çš„å¸¸é‡æ± ï¼ˆConstant Poolï¼‰& ç¬¦å·åº”ç”¨
å‚è€ƒä¸‹é¢çš„ä¾‹å­ï¼Œé€šè¿‡ `javac`  + `javap`æŸ¥çœ‹ç¼–è¯‘åçš„ `.class` æ–‡ä»¶ï¼š
```java
public class Scratch {
    int num = 10;
    public void methodA(){
        System.out.println("methodA()....");
    }
    public void methodB(){
        System.out.println("methodB()....");
        methodA();
        num++;
    }
}

// 1. javac Scratch.java 
// æºä»£ç è½¬åŒ–ä¸ºå­—èŠ‚ç ï¼ˆbyte code = 1111_1111ï¼‰ï¼Œ
// 2. javap -v Scratch.class
// The `javap` tool isÂ used to get the information of any class or interface.
âœ  test git:(master) âœ— javap -v Scratch      
Warning: Binary file Scratch contains test.Scratch
Classfile /Users/henry/IdeaProjects/Head-First-Design-Patterns/src/test/Scratch.class
  Last modified Aug 15, 2021; size 554 bytes
  MD5 checksum 1dac5a22a5ccc66bfd64ee3185a1587e
  Compiled from "Scratch.java"
public class test.Scratch
  minor version: 0
  major version: 52
  flags: ACC_PUBLIC, ACC_SUPER
Constant pool:
   #1 = Methodref          #9.#20         // java/lang/Object."<init>":()V
   #2 = Fieldref           #8.#21         // test/Scratch.num:I
   #3 = Fieldref           #22.#23        // java/lang/System.out:Ljava/io/PrintStream;
   #4 = String             #24            // methodA()....
   #5 = Methodref          #25.#26        // java/io/PrintStream.println:(Ljava/lang/String;)V
   #6 = String             #27            // methodB()....
   #7 = Methodref          #8.#28         // test/Scratch.methodA:()V
   #8 = Class              #29            // test/Scratch
   #9 = Class              #30            // java/lang/Object
  #10 = Utf8               num
  #11 = Utf8               I
  ...
```

å¯ä»¥çœ‹åˆ° class æ–‡ä»¶åŒ…å«ä¸€æ®µ `Constant pool` åŒºåŸŸï¼Œç”¨äºå­˜æ”¾ç¼–è¯‘æœŸç”Ÿæˆçš„å„ç§å­—é¢é‡ï¼ˆ Literal ï¼‰å’Œ ç¬¦å·å¼•ç”¨ï¼ˆSymbolic Referencesï¼‰ã€‚ä¸éš¾ç†è§£ï¼Œåœ¨ç¼–è¯‘é˜¶æ®µï¼Œå¹¶ä¸çŸ¥é“æ‰€å¼•ç”¨ç±»/æ–¹æ³•çš„åœ°å€ï¼ˆå®é™…åœ°å€ï¼‰ï¼Œæ‰€ä»¥å°†**ç¬¦å·å¼•ç”¨**ä¿å­˜è‡³å˜é‡æ± ï¼ˆConstant poolï¼‰

1. å…¶ä¸­ç¬¬ä¸€åˆ— `#1`ï¼Œ`#2` ç­‰ç­‰ä»£è¡¨**ç¬¦å·å¼•ç”¨**ï¼ˆsymbolic referencesï¼‰
2. methodB è°ƒç”¨ methodA å¯¹åº”çš„æŒ‡ä»¤æ˜¯ `9: invokevirtual #36 // Method methodA:()V`

##### 2ï¼‰æ‰€ä»¥ Run-Time Constant Pool æ˜¯ä»€ä¹ˆï¼Ÿ
å…ˆæ¥å›é¡¾ jvm åŠ è½½ä¸€ä¸ªç±»æ—¶ï¼Œä¼šç»å† **åŠ è½½ -> è¿æ¥(éªŒè¯|å‡†å¤‡|è§£æ) -> åˆå§‹åŒ–** ä¸‰ä¸ªé˜¶æ®µã€‚

é¦–å…ˆåœ¨ç¬¬ä¸€æ­¥ **åŠ è½½é˜¶æ®µ**ï¼šè™šæ‹ŸæœºåŠ è½½ Class æ–‡ä»¶åï¼Œä¼šåœ¨å†…å­˜æ–¹æ³•åŒºä¸­ç”Ÿæˆè¿™ä¸ªç±»çš„ java.lang.Class å¯¹è±¡ï¼Œä¾›å¤–éƒ¨è®¿é—®ã€‚åŒæ—¶å°†ä¸Šæ–‡å¸¸é‡æ± ä¸­çš„ç¬¦å·å¼•ç”¨ï¼ˆå­—æ®µ/æ–¹æ³•/ç±»çš„å¼•ç”¨ï¼‰è½¬ç§»è‡³ Run-Time Constant Pool ä¸­ã€‚

ç„¶åå°†å¯¹åº”çš„ã€Œç¬¦å·å¼•ç”¨ã€è½¬åŒ–ä¸ºã€Œç›´æ¥å¼•ç”¨ã€ï¼ˆå®é™…è¿è¡Œæ—¶å†…å­˜å¸ƒå±€ä¸­çš„å…¥å£åœ°å€ï¼‰ï¼Œè¿™ä¸ªè¿‡ç¨‹å«åšâ€œæ–¹æ³•è°ƒç”¨â€ï¼Œè€Œå®ƒåˆåˆ†ä¸ºä»¥ä¸‹ä¸¤ç§ï¼š
1. **è§£æè°ƒç”¨**ï¼šåœ¨**è¿æ¥**æœ€åä¸€æ­¥çš„**è§£æ**é˜¶æ®µï¼Œå®Œæˆç›´æ¥å¼•ç”¨çš„è½¬åŒ–ã€‚
   ä¾‹å¦‚é™æ€æ–¹æ³•ã€ç§æœ‰æ–¹æ³•ã€å®ä¾‹æ„é€ å™¨ã€çˆ¶ç±»æ–¹æ³•ï¼Œä»¥åŠè¢« final ä¿®é¥°çš„å®ä¾‹æ–¹æ³•ï¼Œåœ¨ç¨‹åºçœŸæ­£è¿è¡Œä¹‹å‰å°±æœ‰ä¸€ä¸ªå¯ç¡®å®šçš„è°ƒç”¨ç‰ˆæœ¬ï¼Œå¹¶ä¸”è¿™ä¸ªæ–¹æ³•çš„è°ƒç”¨ç‰ˆæœ¬åœ¨è¿è¡ŒæœŸæ˜¯ä¸å¯æ”¹å˜çš„ï¼Œæ‰€ä»¥åœ¨ç±»åŠ è½½æ—¶å°±èƒ½å®Œæˆç›´æ¥å¼•ç”¨çš„è½¬åŒ–ã€‚
2. **åˆ†æ´¾è°ƒç”¨**ï¼ˆDispatchï¼‰ï¼šæ¯ä¸€æ¬¡è¿è¡ŒæœŸé—´ç¡®è®¤ç›´æ¥å¼•ç”¨ 
   1. é™æ€åˆ†æ´¾ï¼šé‡è½½ï¼ˆOveloadï¼‰- æ ¹æ®é™æ€ç±»å‹å†³å®šé‡è½½çš„ç‰ˆæœ¬
   2. åŠ¨æ€åˆ†æ´¾ï¼šé‡å†™ï¼ˆOverrideï¼‰- æ ¹æ®å¯¹è±¡çš„å®é™…ç±»å‹ï¼Œé€‰æ‹©é‡å†™çš„æ–¹æ³• 

##### 3ï¼‰æ€»è€Œè¨€ä¹‹
è¿è¡Œæ—¶å¸¸é‡æ± ï¼ˆRun-Time Constant Poolï¼‰ä¿å­˜çš„æ˜¯ class æ–‡ä»¶å¸¸é‡æ± æ„å»ºçš„ç¬¦å·å¼•ç”¨ï¼ŒåŒæ—¶åŒ…å«ç¿»è¯‘åçœŸå®å†…å­˜åœ°å€çš„ç›´æ¥å¼•ç”¨ã€‚

p.s. æˆ‘ä»¬å¸¸è¯´çš„ **åŠ¨æ€è¿æ¥**ï¼ˆDynamic Linkingï¼‰ï¼šæŒ‡çš„æ˜¯åœ¨å¼€å¤´å†…å­˜åˆ†å¸ƒå¤§å›¾ä¸­ï¼Œæ ˆå¸§ ï¼ˆStack Frameï¼‰ å­˜åœ¨ä¸€ä¸ªæŒ‡å‘ Run-Time Constant Pool çš„è¿æ¥

## ä¸‰ã€åƒåœ¾æ”¶é›†å™¨ä¸å†…å­˜åˆ†é…ç­–ç•¥

1. å¯¹è±¡æ˜¯å¦å­˜æ´»ï¼Ÿ
  - å¼•ç”¨è®¡æ•°ç®—æ³•ï¼šå¼•ç”¨ä¸º0çš„å¯¹è±¡å¯ä»¥è¢«å½“ä½œåƒåœ¾æ”¶é›†ï¼ˆå¾ªç¯å¼•ç”¨ & çº¿ç¨‹å®‰å…¨ç­‰é—®é¢˜ï¼‰
  - å¯è¾¾æ€§åˆ†ææ³•ï¼šä» gc roots å¼€å§‹ï¼Œå¼•ç”¨å…³ç³»éå†å¯¹è±¡å›¾ï¼Œèƒ½è¢«éå†åˆ°çš„å¯¹è±¡å°±åˆ¤å®šä¸ºå­˜æ´»çš„ï¼Œå…¶ä½™çš„å¯¹è±¡åˆ¤å®šä¸ºæ­»äº¡ã€‚
    gc roots æ˜¯ä»€ä¹ˆï¼Ÿ
    ä¾‹å¦‚å…¨å±€å¼•ç”¨ï¼ˆä¾‹å¦‚é™æ€å˜é‡ï¼‰& æ‰§è¡Œçš„ä¸Šä¸‹æ–‡ï¼ˆæ ˆå¸§ä¸­çš„æœ¬åœ°å˜é‡ï¼‰
2. åˆ†ä»£æ”¶é›†ç†è®ºï¼š
  - å¯¹è±¡åˆå§‹åŒ– -> **Eden**
  - Eden ç©ºé—´ä¸è¶³ -> **Minor GC(YGC)** - æ ‡è®°+å¤åˆ¶
    - Young Generation = eden(80%) + S0(10%) + S1(10%)
    - æ–°ç”Ÿä»£åƒåœ¾å›æ”¶æ­¥éª¤ï¼š
      1. `Eden` -> `S0` 
      2. `Eden` -> `S1`ï¼Œ`S0`->`S1`ï¼ˆäº¤äº’è§¦å‘å¹´é¾„+1ï¼‰
      3. `Eden` -> `S0`ï¼Œ`S1`->`S0`ï¼ˆåŒä¸Šå¹´é¾„+1ï¼‰
      4. è‹¥å¯¹è±¡æœªå›æ”¶ && å¹´é¾„è¶…è¿‡é˜ˆå€¼ï¼š`S0&S1` -> (è€å¹´ä»£)
  - è€å¹´ä»£ç©ºé—´ä¸è¶³ -> **Major GC** - æ ‡è®°+æ•´ç†
    - ï¼ˆé¿å…ç¢ç‰‡çš„æƒ…å†µï¼‰
  - heap æ»¡äº† -> **Full GC** - metaspace & æ•´ä¸ªheap è¿›è¡Œå›æ”¶

å…³äºåƒåœ¾å›æ”¶ç›¸å…³çš„çŸ¥è¯†ç½‘ä¸Šéå¸ƒéƒ½æ˜¯ï¼Œå°±ç®€å• copy äº†ä¸€ä¸‹è‡ªå·±çš„è¯»ä¹¦ç¬”è®°ï¼Œæš‚æ—¶ä¸å±•å¼€ç­é—¨å¼„æ–§äº†ã€‚

## The End
java å°ç™½å†é™©è®°ï¼Œæ–‡ä¸­å¦‚æœ‰é”™è¯¯è¯·å¤šåŒ…æ¶µï¼Œæ¬¢è¿æŒ‡æ­£äº¤æµã€‚
![3FB01AAE-67BF-4755-B6ED-0A301FFB3B36_1_105_c](../images/blog/2021-09-04-jvm-note/3FB01AAE-67BF-4755-B6ED-0A301FFB3B36_1_105_c.jpeg)


## å‚è€ƒ

1. [ã€Šæ·±å…¥ç†è§£ JVM è™šæ‹Ÿæœºã€‹](https://www.dedao.cn/eBook/qPKdG1m9B8MaveyJdxRzNnKYlqgVZ3k4Jlwo5pL7E4m1r26kQjXDAPObGkYgJ4pN)
2. [ã€Šè§£æä¸åˆ†æ´¾ã€‹](https://www.yuque.com/wanghuaihoho/aw880k/zsgm3i)
3. [JEP 122: Remove the Permanent Generation](http://openjdk.java.net/jeps/122)
4. ...


